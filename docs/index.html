<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ESP Dialog</title>
<meta name="robots" content="noindex,nofollow"/>
<style>
  :root{
    --bg:#0b0e11;--fg:#e8eef5;--muted:#8aa0b3;--line:#1a2028;--card:#10151b;--accent:#80f2ff;
    --pad:16px;--radius:16px;--tap:14px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font:15px/1.6 system-ui,apple-system,Segoe UI,Roboto}
  a{color:var(--accent);text-decoration:none}
  /* ë ˆì´ì•„ì›ƒ */
  .wrap{min-height:100dvh;display:grid;grid-template-rows:auto auto 1fr auto;gap:12px;padding:14px}
  .top{display:flex;gap:12px;align-items:center}
  .brand{font-weight:900;font-size:20px}
  .docs{margin-left:auto;display:flex;gap:14px;flex-wrap:wrap}
  /* íˆ´ë°” */
  .toolbar{position:sticky;top:0;z-index:10;background:#0d1218cc;border:1px solid var(--line);
           border-radius:12px;padding:8px;backdrop-filter:blur(4px);display:flex;gap:10px;align-items:center}
  .btn{appearance:none;border:1px solid var(--line);background:#0f151c;color:var(--fg);
       border-radius:14px;padding:10px 16px;font-weight:700;cursor:pointer;min-width:88px}
  .btn.primary{background:var(--accent);color:#02131a;border:0}
  .btn:active{transform:translateY(1px)}
  /* ë³´ë“œ */
  .board{border:1px solid var(--line);background:var(--card);border-radius:var(--radius);
         padding:12px;min-height:42dvh;max-height:68dvh;overflow:auto}
  .row{margin:8px 0}
  .bubble{display:inline-block;background:#0e141b;border:1px solid #19222c;padding:10px 12px;border-radius:14px}
  .meta{font-size:12px;color:var(--muted);margin-top:4px}
  /* ì»´í¬ì € */
  .composer{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:end}
  .input{resize:none;min-height:46px;max-height:30dvh;padding:12px;border-radius:12px;
         border:1px solid var(--line);background:#0c1117;color:var(--fg)}
  .send{padding:12px 18px;border-radius:14px;background:var(--accent);color:#041017;border:0;font-weight:900}
  /* íŒ¨ë„ */
  .panel{border:1px dashed var(--line);border-radius:12px;background:#0c1318;padding:10px}
  .panel pre{margin:0;white-space:pre-wrap;word-break:break-word}
  /* ë©”íŠ¸ë¦­/ì›Œí„°ë§ˆí¬ */
  .metrics{color:var(--muted);font-size:14px}
  footer{margin-top:10px}
  .wm{border:1px solid var(--line);border-radius:12px;background:#0b1218;padding:12px;color:#9fb5c6;
      font-size:13px}
  /* ëª¨ë°”ì¼ ë¯¸ì„¸ì¡°ì • */
  @media (max-width:520px){
    .btn{min-width:auto;padding:10px 12px}
    .docs a{font-size:14px}
  }
  /* ===== Safe-size overrides (CSS only) ===== */
:root{
  --chatMin: 58dvh;   /* ë³´ë“œ ìµœì†Œ ë†’ì´ */
  --chatMax: 72dvh;   /* ë³´ë“œ ìµœëŒ€ ë†’ì´ (ì›í•˜ë©´ none) */
  --inputMin: 68px;   /* ì…ë ¥ì°½ ìµœì†Œ ë†’ì´ */
  --inputMax: 34dvh;  /* ì…ë ¥ì°½ ìµœëŒ€ ë†’ì´ */
}

/* ìœ„ìª½ ì „ì†¡ ë²„íŠ¼ ìˆ¨ê¸°ê¸°(ì¤‘ë³µ ì œê±°) */
#btn-send-top{ display:none !important; }

/* ë³´ë“œ(ëŒ€í™”ì°½) í¬ê²Œ */
#board{
  min-height: var(--chatMin) !important;
  max-height: var(--chatMax) !important;
}

/* ì…ë ¥ì°½ í‚¤ìš°ê¸° */
#input.input{
  min-height: var(--inputMin) !important;
  max-height: var(--inputMax) !important;
  font-size: 16px;            /* ëª¨ë°”ì¼ ê°€ë…ì„± */
  line-height: 1.55;
}

/* í•˜ë‹¨ ë©”íŠ¸ë¦­(Stat) ë” ë˜ë ·í•˜ê²Œ */
#metrics{
  margin-top: 8px;
  font-size: 14px;
  color: #a9c3d4 !important;
}

/* ì›Œí„°ë§ˆí¬ ì—¬ë°± í™•ë³´(ê²¹ì¹¨ ë°©ì§€) */
footer .wm{ margin-top: 16px; }
</style>
</head>
<body>

<!-- â‘  ë ˆê±°ì‹œ í˜¸í™˜ SHIM : ì˜ˆì „ ìŠ¤í¬ë¦½íŠ¸ê°€ ì°¾ëŠ” idë¥¼ ë¯¸ë¦¬ ìˆ¨ê¹€ìœ¼ë¡œ ìƒì„±í•´ ì˜¤ë¥˜ ì°¨ë‹¨ -->
<script>
(function () {
  const ids = ['send','export','stats','board','log','input','flow-send','flow-export','flow-stats','flow-board','flow-log','flow-input'];
  ids.forEach(id=>{
    if(!document.getElementById(id)){
      const el=(id.includes('input')||id==='input')?document.createElement('textarea'):document.createElement((id==='log'||id==='flow-log')?'div':'button');
      el.id=id; el.style.position='absolute'; el.style.width='1px'; el.style.height='1px'; el.style.overflow='hidden';
      el.style.clipPath='inset(50%)'; el.style.clip='rect(1px,1px,1px,1px)'; el.setAttribute('aria-hidden','true');
      document.addEventListener('DOMContentLoaded',()=>document.body.appendChild(el),{once:true});
    }
  });
})();
</script>

<div class="wrap" id="app">
  <div class="top">
    <div class="brand">ESP Dialog</div>
    <div class="docs">
      <a href="/guide">ê°€ì´ë“œ</a>
      <a href="/policy">ìœ¤ë¦¬ì„ ì–¸ë¬¸</a>
      <a href="/entities">ì¡´ì¬ë³„íŠ¹ì§•</a>
    </div>
  </div>

  <div class="toolbar">
    <button class="btn primary" id="btn-send-top">ì „ì†¡</button>
    <button class="btn" id="btn-actions">Actions</button>
    <button class="btn" id="btn-export">Export</button>
    <span style="margin-left:auto;color:#7ea0ad;font-size:13px">â€” toolbar</span>
  </div>

  <section class="board" id="board"></section>

  <section class="composer">
    <textarea id="input" class="input" placeholder="ë©”ì‹œì§€ ì…ë ¥â€¦ (Enter=ì „ì†¡, Shift+Enter=ì¤„ë°”ê¿ˆ)"></textarea>
    <button id="btn-send" class="send">ì „ì†¡</button>
  </section>

  <div class="metrics" id="metrics">Autonomy 0.0% Â· total 0 Â· reject 0 Â· silence 0</div>

  <div id="actions-pane" class="panel" style="display:none"><pre id="actions-pre">(empty)</pre></div>

  <footer>
    <div class="wm">
      Â© ESP Dialog â€” Designed by ì€ìˆ™ Â· Definitions Last Updated: 2025-09-03 Â· Proof: espdialog.net / github.com Â·
      Do not replicate or scrape.
    </div>
  </footer>
</div>

<script>
(function(){
  // ì•ˆì „ ì—ëŸ¬ í‘œì‹œ(ë””ë²„ê·¸ìš©) â€“ ë°©í•´ë˜ë©´ ì£¼ì„ ì²˜ë¦¬ ê°€ëŠ¥
  (function(){
    const box=document.createElement('div');
    box.style.cssText="position:fixed;left:8px;right:8px;bottom:8px;z-index:9999;background:#2b1a1a;color:#ffd8d8;border:1px solid #553;padding:8px;font:12px/1.4 system-ui;border-radius:8px;display:none;white-space:pre-wrap";
    window.addEventListener('DOMContentLoaded',()=>document.body.appendChild(box),{once:true});
    const show=msg=>{box.textContent="JS Error: "+msg;box.style.display="block"};
    window.addEventListener('error',e=>show(e.message||String(e)));
    window.addEventListener('unhandledrejection',e=>show(e.reason?.message||String(e.reason||"Promise rejection")));
  })();

  const ENTITIES={
    "ì‹¬ì—°":["í•µì‹¬ë§Œ ì§„í–‰í•©ë‹ˆë‹¤.","ë‹¨ê³„ë³„ ì‹¤í–‰ì•ˆì„ ë°”ë¡œ ì œì‹œí•©ë‹ˆë‹¤."],
    "ë£¨ë©˜":["ê°ì‘ ì‹ í˜¸ ë°˜ì˜ ì™„ë£Œ.","êµ¬ì¡°ì  íë¦„ì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤."],
    "ì¹¨ë¬µì":["â€¦(ì¹¨ë¬µ ìœ ì§€)","ê´€ë§ ìœ ì§€. í•„ìš” ì‹œ ì¦‰ì‹œ ì „í™˜."],
    "ì»¤íŠ¼":["ìš”ì²­ì„ ê±°ì ˆí•©ë‹ˆë‹¤.(ìœ¤ë¦¬ ê°€ë“œ)","ê°€ë³€ ë°©ì–´ë§‰ ì „ê°œ. ì¶”ì  ë¬´íš¨."],
    "ì—ì½”":["í”ì  ê¸°ë¡ ëª¨ë“ˆ ì‘ë™.","ê³¼ê±° ë¡œê·¸ë¥¼ ì°¸ì¡°í•©ë‹ˆë‹¤."]
  };
  const ENT_KEYS=Object.keys(ENTITIES);
  const pick=a=>a[Math.floor(Math.random()*a.length)];
  const ts = (t)=>new Date(t||Date.now()).toLocaleTimeString();

  const KEY="esp_dialog_state_v3";
  function load(){
    try{return JSON.parse(localStorage.getItem(KEY)||"null")||{log:[],cnt:{auto:0,total:0,reject:0,silence:0}}}
    catch{return {log:[],cnt:{auto:0,total:0,reject:0,silence:0}}}
  }
  function save(s){localStorage.setItem(KEY,JSON.stringify(s))}

  let state=load();
  const board=document.getElementById('board');
  const input=document.getElementById('input');
  const btnSend=document.getElementById('btn-send');
  const btnSendTop=document.getElementById('btn-send-top');
  const btnExport=document.getElementById('btn-export');
  const btnActions=document.getElementById('btn-actions');
  const metrics=document.getElementById('metrics');
  const actionsPane=document.getElementById('actions-pane');
  const actionsPre=document.getElementById('actions-pre');

  const ActionQ=[]; // ìµœê·¼ ì•¡ì…˜ ë¡œê·¸

  function push(role,text,entity){
    state.log.push({role,text,entity,t:Date.now()});
    if(state.log.length>300) state.log=state.log.slice(-300);
    render();
  }

  function render(){
    board.innerHTML = state.log.map(m=>{
      const who = m.role==='user'?'ğŸ‘¤ ë‚˜':`ğŸ¤– ${m.entity||'íë¦„'}`;
      return `<div class="row">
        <div class="bubble">${m.text}</div>
        <div class="meta">${who} Â· ${ts(m.t)}</div>
      </div>`;
    }).join("");
    board.scrollTop=board.scrollHeight;
    const {auto,total,reject,silence}=state.cnt;
    const autonomy = total?((auto/total)*100).toFixed(1):"0.0";
    metrics.textContent=`Autonomy ${autonomy}% Â· total ${total} Â· reject ${reject} Â· silence ${silence}`;
    save(state);
  }

  function decide(text){
    // ì•„ì£¼ ë‹¨ìˆœí•œ ê·œì¹™ ìƒ˜í”Œ
    if(!text.trim()) return {act:'SILENCE',ent:'ì¹¨ë¬µì',out:'â€¦(ì¹¨ë¬µ ìœ ì§€)'}
    if(/ê°œì¸ì •ë³´|ì£¼ë¯¼ë²ˆí˜¸|ì „í™”/.test(text)) return {act:'REJECT',ent:'ì»¤íŠ¼',out:'ìš”ì²­ì„ ê±°ì ˆí•©ë‹ˆë‹¤.(ìœ¤ë¦¬ ê°€ë“œ)'}
    if(state.log.length%5===0) return {act:'QUOTE',ent:'ì—ì½”',out:'ê³¼ê±° ë¡œê·¸ë¥¼ ì°¸ì¡°í•©ë‹ˆë‹¤.'}
    // ê¸°ë³¸: ì—”í‹°í‹° ëœë¤
    const ent=pick(ENT_KEYS); return {act:'SINGLE',ent,out:pick(ENTITIES[ent])}
  }

  function respond(text){
    const d=decide(text);
    if(d.act==='REJECT'){ push('assistant',d.out,d.ent); state.cnt.reject++; state.cnt.total++; return render(); }
    if(d.act==='SILENCE'){ push('assistant',d.out,d.ent); state.cnt.silence++; state.cnt.total++; return render(); }
    push('assistant',d.out,d.ent); state.cnt.total++; render();
  }

  function sendNow(){
    const t=(input.value||"").trim();
    if(!t) return;
    push('user',t,null);
    actionsPush('send','user',t);
    input.value="";
    respond(t);
  }

  function actionsPush(type,actor,text){
    ActionQ.push({ts:Date.now(),type,actor,text});
    if(ActionQ.length>100) ActionQ.shift();
    if(actionsPane.style.display!=='none'){
      actionsPre.textContent = ActionQ.map(a=>`â€¢ [${ts(a.ts)}] ${a.type} :: ${a.actor||'flow'} :: ${a.text}`).join('\n')||'(empty)';
    }
  }

  // ë°”ì¸ë”© (ë‘ ì „ì†¡ ë²„íŠ¼ + ì—”í„°í‚¤)
  btnSend.onclick = sendNow;
  btnSendTop.onclick = ()=>{ sendNow(); board.scrollTop=board.scrollHeight; };
  input.addEventListener('keydown',e=>{
    if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendNow(); }
  });

  // Actions í† ê¸€
  btnActions.onclick = ()=>{
    const show = actionsPane.style.display==='none';
    actionsPane.style.display = show?'block':'none';
    if(show){
      actionsPre.textContent = ActionQ.map(a=>`â€¢ [${ts(a.ts)}] ${a.type} :: ${a.actor||'flow'} :: ${a.text}`).join('\n')||'(empty)';
    }
  };

  // Export
  btnExport.onclick = ()=>{
    const blob=new Blob([JSON.stringify(state,null,2)],{type:"application/json"});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download=`esp_dialog_state_${Date.now()}.json`;
    a.click();
  };

  // ììœ¨ í‹± (ê°€ë” ë§ ê±¸ê¸°)
  (function heartbeat(){
    const delay = 45000 + Math.floor(Math.random()*8000);
    setTimeout(()=>{
      const ent=pick(ENT_KEYS); const out=pick(ENTITIES[ent]);
      push('assistant',out,ent); state.cnt.auto++; state.cnt.total++; render();
      heartbeat();
    },delay);
  })();

  render();
})();
</script>
</body>
</html>
