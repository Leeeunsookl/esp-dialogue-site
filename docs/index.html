<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ESP Dialog</title>
<meta name="robots" content="noindex,nofollow"/>
<style>
  :root{
    --bg:#0b0e11;--fg:#e8eef5;--muted:#8aa0b3;--line:#1a2028;--card:#10151b;--accent:#80f2ff;
    --radius:16px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font:15px/1.6 system-ui,apple-system,Segoe UI,Roboto}
  a{color:var(--accent);text-decoration:none}

  .wrap{min-height:100dvh;display:grid;grid-template-rows:auto auto 1fr auto;gap:12px;padding:14px}
  .top{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .brand{font-weight:900;font-size:24px;line-height:1}
  .docs{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
  .docs a{font-size:13px;padding:6px 10px;border:1px solid var(--line);border-radius:12px;background:#0d1218}

  .toolbar{position:sticky;top:0;z-index:5;background:#0d1218cc;border:1px solid var(--line);
           border-radius:12px;padding:6px 8px;backdrop-filter:blur(4px);display:flex;gap:8px;align-items:center}
  .btn{appearance:none;border:1px solid var(--line);background:#0f151c;color:var(--fg);
       border-radius:14px;padding:8px 14px;font-weight:700;cursor:pointer;min-width:72px}

  /* 대화 보드 */
  #board{position:relative;z-index:0;border:1px solid var(--line);background:var(--card);
         border-radius:var(--radius);padding:12px;min-height:60dvh;max-height:72dvh;overflow:auto}
  .row{margin:8px 0}
  .bubble{display:inline-block;background:#0e141b;border:1px solid #19222c;padding:10px 12px;border-radius:14px}
  .meta{font-size:12px;color:var(--muted);margin-top:4px}

  /* 입력영역 */
  .composer{position:relative;isolation:isolate} /* 버튼/입력 z-index 분리 */
  #input{display:block;width:100%;resize:none;min-height:68px;max-height:34dvh;
         padding:12px 56px 12px 12px;border-radius:12px;border:1px solid var(--line);
         background:#0c1117;color:var(--fg);font-size:16px;line-height:1.55;
         pointer-events:auto;z-index:1}
  #input::placeholder{color:#7f93a6;font-size:14px}
  #send{position:absolute;right:8px;bottom:8px;width:36px;height:36px;border:0;border-radius:10px;
        background:var(--accent);color:#041017;font-weight:900;display:flex;align-items:center;
        justify-content:center;z-index:2}
  #send:active{transform:translateY(1px)}

  .metrics{color:#a9c3d4;font-size:14px;margin-top:10px}
  footer .wm{border:1px solid var(--line);border-radius:12px;background:#0b1218;padding:12px;color:#9fb5c6;
             font-size:13px;margin-top:12px}

  @media (max-width:520px){
    .btn{min-width:auto;padding:8px 12px;font-size:14px}
    .docs a{font-size:12px}
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div class="brand">ESP<br/>Dialog</div>
    <div class="docs">
      <a href="./guide.html">가이드</a>
      <a href="./policy.html">윤리선언문</a>
      <a href="./entities.html">존재별특징</a>
    </div>
  </div>

  <div class="toolbar">
    <button class="btn" id="btn-export">Export</button>
    <button class="btn" id="btn-stats">Stats</button>
    <button class="btn" id="btn-actions">Actions</button>
    <span style="margin-left:auto;font-size:13px;color:#8aa0b3">— toolbar</span>
  </div>

  <div id="board"></div>

  <div class="composer">
    <textarea id="input" placeholder="메시지 입력…  (Enter=전송, Shift+Enter=줄바꿈)"
      rows="3" autocapitalize="none" autocomplete="off" autocorrect="off"
      spellcheck="false" inputmode="text"></textarea>
    <button id="send" aria-label="전송">➤</button>
  </div>

  <footer>
    <div id="metrics" class="metrics">Autonomy 0.0% · total 0 · reject 0 · silence 0</div>
    <div class="wm">© ESP Dialogue Team — Definitions Last Updated: 2025-09-03<br/>Page signed with digital watermark. All rights reserved.</div>
  </footer>
</div>

<script src="./esp_autopilot.js"></script>
<script>
/* esp_autopilot inline v11 — hard bind + badge + error overlay */
(function () {
  // 0) 로드 배지
  (function () {
    const b = document.createElement('div');
    b.textContent = 'JS:v11';
    Object.assign(b.style, {
      position: 'fixed', right: '8px', bottom: '8px', zIndex: 9998,
      font: '11px/1 system-ui', color: '#0b1', background: '#041',
      padding: '2px 6px', borderRadius: '6px', opacity: '0.85'
    });
    document.addEventListener('DOMContentLoaded', () => document.body.appendChild(b), { once: true });
  })();

  // 1) 에러 박스
  (function(){
    const box=document.createElement("div");
    box.style.cssText="position:fixed;left:8px;right:8px;bottom:28px;z-index:9999;background:#2b1a1a;color:#ffd8d8;border:1px solid #553;padding:8px;font:12px/1.4 system-ui;border-radius:8px;display:none;white-space:pre-wrap";
    window.addEventListener("error",e=>{box.textContent="JS Error: "+(e.message||String(e));box.style.display="block";});
    window.addEventListener("unhandledrejection",e=>{box.textContent="JS Error: "+(e.reason?.message||String(e.reason));box.style.display="block";});
    document.addEventListener("DOMContentLoaded",()=>document.body.appendChild(box),{once:true});
  })();

  // 2) 상태
  const KEY="esp_flow_state_v11";
  const ENT={
    "심연":["핵심만 진행합니다.","단계별 실행안을 바로 제시합니다."],
    "루멘":["감응 신호 반영 완료.","구조적 흐름을 확인했습니다."],
    "에코":["흔적 기록 모듈 작동.","과거 로그를 참조합니다."],
    "침묵자":["…(침묵 유지)","관망 유지. 필요 시 즉시 전환."],
    "커튼":["요청을 거절합니다.(윤리 가드)","가변 방어막 전개. 추적 무효."]
  };
  const pick=a=>a[Math.floor(Math.random()*a.length)];
  function load(){try{return JSON.parse(localStorage.getItem(KEY)||"null")||{log:[],cnt:{auto:0,total:0,reject:0,silence:0}}}catch{return{log:[],cnt:{auto:0,total:0,reject:0,silence:0}}}
  function save(s){localStorage.setItem(KEY,JSON.stringify(s));}

  function render(state){
    const board=document.getElementById('board');
    if(board){
      board.innerHTML=state.log.map(m=>{
        const who=m.role==='user'?'👤 나':`🤖 ${m.entity||'흐름'}`;
        const time=new Date(m.t).toLocaleTimeString();
        return `<div class="row ${m.role==='user'?'me':''}">
          <div><div class="bubble">${m.text}</div><div class="meta">${who} · ${time}</div></div>
        </div>`;
      }).join('');
      board.scrollTop=board.scrollHeight;
    }
    const mt=document.getElementById('metrics');
    if(mt){
      const {auto,total,reject,silence}=state.cnt;
      const autonomy=total?((auto/total)*100).toFixed(1):"0.0";
      mt.textContent=`Autonomy ${autonomy}% · total ${total} · reject ${reject} · silence ${silence}`;
    }
  }

  function boot(){
    const state=load(); render(state);
    const input=document.getElementById('input');
    let send=document.getElementById('send');

    if(!input||!send){ return setTimeout(boot,200); } // 레이아웃 지연 대비 재시도

    // 버튼 하드 리바인드
    send.type='button';
    if(send.hasAttribute('onclick')) send.removeAttribute('onclick');
    const clone=send.cloneNode(true); send.replaceWith(clone);
    send=document.getElementById('send');

    function push(role,text,entity){
      state.log.push({t:Date.now(),role,text,entity});
      if(state.log.length>300) state.log=state.log.slice(-300);
      save(state); render(state);
    }
    function respond(txt){
      if(/개인정보|주민번호|비번/.test(txt)){
        state.cnt.reject++; state.cnt.total++;
        push('assistant',"요청을 거절합니다.(윤리 가드)","커튼"); return;
      }
      const ent=pick(Object.keys(ENT)), out=pick(ENT[ent]);
      state.cnt.total++; push('assistant',out,ent);
    }
    function onSend(){
      const txt=(input.value||'').trim(); if(!txt) return;
      input.value=''; push('user',txt,null); respond(txt);
    }

    // 3중 폴백
    send.addEventListener('click',onSend,{passive:true});
    send.onclick=onSend;
    document.addEventListener('click',(e)=>{ const t=e.target?.closest?.('#send'); if(t) onSend(); },true);

    // Enter = 전송 / Shift+Enter = 줄바꿈
    input.addEventListener('keydown',(e)=>{
      if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); onSend(); }
    });

    // Export(있으면)
    const ex=document.getElementById('btn-export');
    if(ex){
      ex.type='button';
      ex.addEventListener('click',()=>{
        const lastHash=state.log.length?String(state.log[state.log.length-1].t):"";
        const data={...state,proof:{lastHash,at:Date.now()}};
        const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
        const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
        a.download=`esp_flow_state_${Date.now()}.json`; a.click();
      },{passive:true});
    }
  }

  document.addEventListener('DOMContentLoaded',boot,{once:true});
})();
</script>
</body>
</html>
