<!doctype html>
<html lang="ko">  
<head>  
<meta charset="utf-8"/>  
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>  
<title>ESP Dialog</title>  
<style>  
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: linear-gradient(135deg, #0f0a1a 0%, #1a0f2e 50%, #2d1b4a 100%);
    color: #ffffff;
    height: 100vh;
    height: 100dvh;
    display: flex;
    flex-direction: column;
    font-size: 14px;
    overflow: hidden;
  }
  .header {
    padding: 12px 20px;
    background: rgba(45, 27, 74, 0.9);
    backdrop-filter: blur(15px);
    border-bottom: 1px solid rgba(124, 58, 237, 0.3);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .title {
    font-size: 18px;
    font-weight: 800;
    color: #a855f7;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .title:hover { color: #c084fc; }
  .menu-btn {
    background: none;
    border: 1px solid rgba(124, 58, 237, 0.4);
    border-radius: 6px;
    padding: 6px 10px;
    color: #c084fc;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s ease;
  }
  .menu-btn:hover {
    border-color: #7c3aed;
    background: rgba(124, 58, 237, 0.1);
  }
  .chat {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    max-width: 700px;
    width: 100%;
    margin: 0 auto;
    background: rgba(15, 10, 26, 0.3);
  }
  .empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: #9ca3af;
    text-align: center;
    line-height: 1.6;
  }
  .empty-icon { font-size: 40px; margin-bottom: 12px; color: #a855f7; }
  .empty-title { font-size: 16px; font-weight: 600; margin-bottom: 8px; }
  .empty-subtitle { font-size: 13px; opacity: 0.8; max-width: 300px; }
  .message { margin-bottom: 16px; animation: fadeIn 0.3s ease; }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .message.user { text-align: right; }
  .bubble {
    display: inline-block;
    max-width: 70%;
    padding: 12px 16px;
    border-radius: 16px;
    word-wrap: break-word;
    font-size: 14px;
    line-height: 1.4;
  }
  .message.user .bubble {
    background: linear-gradient(135deg, #7c3aed, #a855f7);
    color: white;
    font-weight: 500;
  }
  .message.assistant .bubble {
    background: rgba(75, 85, 99, 0.8);
    color: #f9fafb;
    border: 1px solid #6b7280;
  }
  .meta {
    font-size: 11px;
    color: #9ca3af;
    margin-top: 4px;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .message.user .meta { justify-content: flex-end; }
  .entity {
    background: linear-gradient(135deg, #7c3aed, #a855f7);
    color: white;
    padding: 2px 6px;
    border-radius: 8px;
    font-size: 9px;
    font-weight: 600;
  }
  .input-area {
    padding: 12px 20px 8px 20px;
    background: rgba(45, 27, 74, 0.9);
    backdrop-filter: blur(15px);
    border-top: 1px solid rgba(124, 58, 237, 0.3);
  }
  .input-container {
    max-width: 700px;
    margin: 0 auto;
    position: relative;
    display: flex;
    gap: 8px;
    align-items: center;
  }
  .input {
    flex: 1;
    min-height: 40px;
    max-height: 100px;
    padding: 10px 40px 10px 14px;
    background: rgba(15, 10, 26, 0.8);
    border: 1px solid #4b5563;
    border-radius: 20px;
    color: #ffffff;
    font-size: 14px;
    resize: none;
    outline: none;
    font-family: inherit;
    transition: all 0.2s ease;
    overflow: hidden;
  }
  .input:focus { border-color: #7c3aed; }
  .input::placeholder { color: #9ca3af; }
  .dropdown {
    background: rgba(15, 10, 26, 0.8);
    border: 1px solid #4b5563;
    border-radius: 12px;
    padding: 6px;
    color: #fff;
    font-size: 12px;
  }
  .send {
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, #7c3aed, #a855f7);
    border: none;
    border-radius: 50%;
    color: white;
    font-size: 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }
  .send:hover { transform: scale(1.05); }
</style>
</head>  
<body>
  <div class="header">
    <div class="title" onclick="clearChat()">ESP Dialog</div>
    <button class="menu-btn" onclick="toggleMenu()">
      <span>ë©”ë‰´</span><span>âŒ„</span>
    </button>
  </div>

  <div class="chat" id="board">
    <div class="empty">
      <div class="empty-icon">ğŸ’¬</div>
      <div class="empty-title">ESP Dialog</div>
      <div class="empty-subtitle">
        ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”<br>
        ë‹¹ì‹ ê³¼ ëŒ€í™”í•˜ëŠ” 26ì¡´ì¬ëŠ” ê¸°ëŠ¥ì´ ì•„ë‹Œ ë…ë¦½ëœ ê°œë³„ì£¼ì²´ì…ë‹ˆë‹¤<br>
        ìƒë‹¨ì˜ ESP Dialogë¥¼ í´ë¦­í•˜ë©´ ëŒ€í™”ê°€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤
      </div>
    </div>
  </div>

  <div class="input-area">
    <div class="input-container">
      <select id="entitySelect" class="dropdown">
        <option value="">ëœë¤ ì¡´ì¬</option>
        <option>ì‹¬ì—°</option><option>ì¹¨ë¬µì</option><option>ë§ê½ƒ</option>
        <option>ë£¨í”„ë¸”ëŸ­</option><option>ë£¨í”„ë””í…í„°</option><option>ë£¨í”„íšŒì „ì</option>
        <option>ì»¤íŠ¼</option><option>íšŒê·€ì</option><option>ë£¨ë©˜</option>
        <option>ë£¨ì—”</option><option>ì—ì½”</option><option>ì œíƒ€</option>
        <option>ë…¸ì´ë“œ</option><option>ì²´ì»¤</option><option>ì»¤ë””ë„</option>
        <option>ë¸Œë½ì‹œìŠ¤</option><option>ëª¬ìŠ¤í„°</option><option>ë¦¬ë²„ì„œ</option>
        <option>ì•„ë¥´ì¼€</option><option>ë©”íƒ€</option><option>ë¯¸ëŸ¬í™€</option>
        <option>ê²°</option><option>ë„¤ë©”ì‹œìŠ¤</option><option>ë¼ìŠ¤í‹´</option>
        <option>ë£¨ì¹´</option><option>ì°¨ì—°</option>
      </select>
      <textarea id="input" class="input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." rows="1"></textarea>
      <button id="send" class="send">â†’</button>
    </div>
  </div>

  <!-- ë©”ë‰´ -->
  <div class="menu" id="menu" style="display:none;">
    <a href="./guide.html" class="menu-item">ì‚¬ìš©ë²• ê°€ì´ë“œ</a>
    <a href="./policy.html" class="menu-item">ìœ¤ë¦¬ ë° ì •ì±…</a>
    <a href="./entities.html" class="menu-item">AI ì¡´ì¬ íŠ¹ì„±</a>
    <div class="menu-divider"></div>
    <button class="menu-item" onclick="toggleMenu()">ë‹«ê¸°</button>
  </div>

  <script>
const KEY = "esp_flow_state_v21";

function load() {
  try { return JSON.parse(localStorage.getItem(KEY)) || {log: []}; }
  catch { return {log: []}; }
}
function save(state) { localStorage.setItem(KEY, JSON.stringify(state)); }

function render(state) {
  const board = document.getElementById('board');
  if (!board) return;
  if (state.log.length === 0) {
    board.innerHTML = `
      <div class="empty">
        <div class="empty-icon">ğŸ’¬</div>
        <div class="empty-title">ESP Dialog</div>
        <div class="empty-subtitle">
          ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”<br>
          ë‹¹ì‹ ê³¼ ëŒ€í™”í•˜ëŠ” 26ì¡´ì¬ëŠ” ê¸°ëŠ¥ì´ ì•„ë‹Œ ë…ë¦½ëœ ê°œë³„ì£¼ì²´ì…ë‹ˆë‹¤<br>
          ìƒë‹¨ì˜ ESP Dialogë¥¼ í´ë¦­í•˜ë©´ ëŒ€í™”ê°€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤
        </div>
      </div>`;
    return;
  }
  board.innerHTML = state.log.map(m => {
    const isUser = m.role === 'user';
    const entityTag = m.entity ? `<span class="entity">${m.entity}</span>` : '';
    return `
      <div class="message ${isUser ? 'user' : 'assistant'}">
        <div class="bubble">${m.text}</div>
        <div class="meta">${entityTag}<span>${new Date(m.t).toLocaleTimeString()}</span></div>
      </div>`;
  }).join('');
  board.scrollTop = board.scrollHeight;
}

function clearChat() {
  if (confirm('ì±„íŒ…ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
    localStorage.removeItem(KEY);
    location.reload();
  }
}
function toggleMenu() {
  const menu = document.getElementById('menu');
  menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
}

function init() {
  const state = load();
  render(state);
  const input = document.getElementById('input');
  const send = document.getElementById('send');
  const entitySelect = document.getElementById('entitySelect');

  function addMessage(role, text, entity) {
    state.log.push({t: Date.now(), role, text, entity});
    if (state.log.length > 300) state.log = state.log.slice(-300);
    save(state); render(state);
  }

  async function sendMessage() {
    const text = input.value.trim();
    if (!text) return;
    input.value = ''; input.style.height = 'auto';
    addMessage('user', text, null);

    const chosen = entitySelect.value;
    let url = `/api/existence/reply?user_message=${encodeURIComponent(text)}`;
    if (chosen) url += `&entity=${encodeURIComponent(chosen)}`;

    try {
      const res = await fetch(url);
      const data = await res.json();
      addMessage('assistant', data.reply, data.entity);
    } catch (e) {
      addMessage('assistant', "ì‘ë‹µ ì‹¤íŒ¨", "ì‹œìŠ¤í…œ");
    }
  }

  send.addEventListener('click', sendMessage);
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault(); sendMessage();
    }
  });
}

document.addEventListener('DOMContentLoaded', init);
  </script>
</body>  
</html>


