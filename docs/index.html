<!doctype html>
<html lang="ko">  
<head>  
<meta charset="utf-8"/>  
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>  
<title>ESP Dialog</title>  
<style>  
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: #0f0a1a;
    color: #ffffff;
    height: 100vh;
    display: flex;
    flex-direction: column;
    font-size: 14px;
    overflow: hidden;
  }
  .header {
    padding: 12px 20px;
    background: rgba(45, 27, 74, 0.9);
    border-bottom: 1px solid rgba(124, 58, 237, 0.3);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .title {
    font-size: 18px;
    font-weight: 800;
    color: #a855f7;
    cursor: pointer;
  }
  .chat {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    max-width: 700px;
    width: 100%;
    margin: 0 auto;
    background: rgba(15, 10, 26, 0.3);
  }
  .message { margin-bottom: 16px; }
  .message.user { text-align: right; }
  .bubble {
    display: inline-block;
    max-width: 70%;
    padding: 12px 16px;
    border-radius: 16px;
    font-size: 14px;
    line-height: 1.4;
  }
  .message.user .bubble {
    background: linear-gradient(135deg, #7c3aed, #a855f7);
    color: white;
  }
  .message.assistant .bubble {
    background: rgba(75, 85, 99, 0.8);
    color: #f9fafb;
    border: 1px solid #6b7280;
  }
  .meta {
    font-size: 11px;
    color: #9ca3af;
    margin-top: 4px;
  }
  .message.user .meta { justify-content: flex-end; }
  .input-area {
    padding: 12px 20px 8px 20px;
    background: rgba(45, 27, 74, 0.9);
    border-top: 1px solid rgba(124, 58, 237, 0.3);
  }
  .input-container { max-width: 700px; margin: 0 auto; position: relative; }
  .input {
    width: 100%;
    min-height: 40px;
    padding: 10px 40px 10px 14px;
    background: rgba(15, 10, 26, 0.8);
    border: 1px solid #4b5563;
    border-radius: 20px;
    color: #ffffff;
    font-size: 14px;
    resize: none;
    outline: none;
    font-family: inherit;
    overflow: hidden;
  }
  .send {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    width: 28px;
    height: 28px;
    background: linear-gradient(135deg, #7c3aed, #a855f7);
    border: none;
    border-radius: 50%;
    color: white;
    cursor: pointer;
  }
</style>
</head>  
<body>
  <div class="header">
    <div class="title" onclick="clearChat()">ESP Dialog</div>
  </div>

  <div class="chat" id="board">
    <div class="empty">
      <div style="font-size:40px;margin-bottom:12px;color:#a855f7;">💬</div>
      <div style="font-size:16px;font-weight:600;margin-bottom:8px;">ESP Dialog</div>
      <div style="font-size:13px;opacity:0.8;">
        대화를 시작해보세요<br>
        26 존재가 독립적으로 응답합니다
      </div>
    </div>
  </div>

  <div class="input-area">
    <div class="input-container">
      <textarea id="input" class="input" placeholder="메시지를 입력하세요..." rows="1"></textarea>
      <button id="send" class="send">→</button>
    </div>
  </div>

<script>
const board = document.getElementById('board');
const input = document.getElementById('input');
const send = document.getElementById('send');

function addMessage(role, text) {
  const msg = document.createElement('div');
  msg.className = `message ${role}`;
  msg.innerHTML = `<div class="bubble">${text}</div>
                   <div class="meta">${new Date().toLocaleTimeString()}</div>`;
  board.appendChild(msg);
  board.scrollTop = board.scrollHeight;
}

async function sendMessage() {
  const text = input.value.trim();
  if (!text) return;
  addMessage('user', text);
  input.value = '';

  // 1. 사용자 발화 저장
  await fetch('/talk?text=' + encodeURIComponent(text));

  // 2. 존재 응답 요청
  try {
    const res = await fetch('/existence/reply');
    const data = await res.json();
    addMessage('assistant', data.reply || "(응답 없음)");
  } catch (e) {
    addMessage('assistant', "오류 발생");
  }
}

send.addEventListener('click', sendMessage);
input.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

function clearChat() {
  board.innerHTML = `<div class="empty">
    <div style="font-size:40px;margin-bottom:12px;color:#a855f7;">💬</div>
    <div style="font-size:16px;font-weight:600;margin-bottom:8px;">ESP Dialog</div>
    <div style="font-size:13px;opacity:0.8;">
      대화를 시작해보세요<br>
      26 존재가 독립적으로 응답합니다
    </div>
  </div>`;
}
</script>
</body>  
</html>
