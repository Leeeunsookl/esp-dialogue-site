<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ESP Dialog</title>
<meta name="robots" content="noindex,nofollow"/>

<style>
  :root{
    --bg:#0b0e11; --fg:#e8eef5; --muted:#8aa0b3; --line:#1a2028; --card:#10151b; --accent:#80f2ff;
    --pad:16px; --radius:16px;
  }
  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{
    margin:0; background:var(--bg); color:var(--fg);
    font:15px/1.6 system-ui,apple-system,Segoe UI,Roboto;
  }
  a{ color:var(--accent); text-decoration:none }
  .wrap{
    min-height:100dvh;
    display:grid;
    grid-template-rows: auto auto 1fr auto auto auto; /* í—¤ë”,íˆ´ë°”,ë³´ë“œ,ì»´í¬ì €,ë©”íŠ¸ë¦­,ì›Œí„°ë§ˆí¬ */
    gap:12px; padding:14px;
  }

  /* í—¤ë” */
  .top{ display:flex; gap:10px; align-items:center }
  .brand{ font-weight:900; font-size:15px }
  .docs{ margin-left:auto; display:flex; gap:10px; flex-wrap:wrap }
  .chip{ padding:6px 10px; border:1px solid var(--line); border-radius:999px; color:#a8def0 }

  /* íˆ´ë°” */
  .toolbar{
    position:sticky; top:0; z-index:5;
    background:#0d1218cc; backdrop-filter:blur(4px);
    border:1px solid var(--line); border-radius:12px; padding:8px;
    display:flex; gap:10px; align-items:center;
  }
  .btn{
    appearance:none; cursor:pointer;
    border:1px solid var(--line); background:#0f151c; color:var(--fg);
    border-radius:14px; padding:10px 16px; font-weight:700;
  }
  .btn:active{ transform:translateY(1px) }

  /* ëŒ€í™” ë³´ë“œ(ì—¬ê¸°ê°€ ìœ ì¼í•œ ìŠ¤í¬ë¡¤ ì˜ì—­) */
  .board{
    border:1px solid var(--line); background:var(--card); border-radius:var(--radius);
    padding:12px; min-height:56dvh; max-height:66dvh; overflow:auto;
  }
  .row{ margin:10px 0 }
  .who{ font-size:12px; color:#a7c79b; margin-bottom:4px }
  .bubble{
    display:inline-block; background:#0e141b; border:1px solid #19222c;
    padding:10px 12px; border-radius:14px;
  }

  /* ì…ë ¥ + ì „ì†¡ */
  .composer{
    display:grid; grid-template-columns:1fr auto; gap:10px; align-items:end;
  }
  .input{
    resize:none; min-height:64px; max-height:32dvh;
    padding:12px; border-radius:12px; border:1px solid var(--line);
    background:#0c1117; color:var(--fg);
  }
  .send{
    width:42px; height:42px; padding:0; border-radius:50%;
    border:0; background:var(--accent); color:#041017; font-weight:900;
    display:flex; align-items:center; justify-content:center;
  }
  .send svg{ width:18px; height:18px; }

  /* ë©”íŠ¸ë¦­ + ì›Œí„°ë§ˆí¬ */
  .metrics{ color:#a9c3d4; font-size:14px }
  footer{ /* ì›Œí„°ë§ˆí¬ëŠ” ê³ ì • X, í˜ì´ì§€ í•˜ë‹¨ì— ìë¦¬ë§Œ ì°¨ì§€ */
    border:1px solid var(--line); border-radius:12px; background:#0b1218;
    color:#9fb5c6; padding:12px; font-size:13px;
  }
  .wm-small{ font-size:12px; opacity:.9 }

  /* ëª¨ë°”ì¼ ë¯¸ì„¸ì¡°ì • */
  @media (max-width:520px){
    .btn{ padding:10px 12px }
    .docs .chip{ font-size:13px; padding:5px 9px }
  }

  /* ì—ëŸ¬ ì˜¤ë²„ë ˆì´(ë³´ì´ë©´ ì¦‰ì‹œ ì›ì¸ í™•ì¸) */
  .errbox{
    position:fixed; left:8px; right:8px; bottom:8px; z-index:9999;
    display:none; background:#2b1a1a; color:#ffd8d8; border:1px solid #553;
    padding:8px; border-radius:8px; white-space:pre-wrap; font:12px/1.4 system-ui;
  }
</style>
</head>
<body>
<div class="wrap">

  <!-- í—¤ë” -->
  <div class="top">
    <div class="brand">ESP Dialog</div>
    <nav class="docs">
      <a class="chip" href="/guide.html">ê°€ì´ë“œ</a>
      <a class="chip" href="/charter.html">ìœ¤ë¦¬ì„ ì–¸ë¬¸</a>
      <a class="chip" href="/traits.html">ì¡´ì¬ë³„íŠ¹ì§•</a>
    </nav>
  </div>

  <!-- íˆ´ë°” -->
  <div class="toolbar">
    <button class="btn" id="btnExport">Export</button>
    <button class="btn" id="btnStats">Stats</button>
    <button class="btn" id="btnActions">Actions</button>
    <span style="margin-left:auto;color:#99b28c">â€” toolbar</span>
  </div>

  <!-- ëŒ€í™”íŒ -->
  <div class="board" id="board" aria-live="polite"></div>

  <!-- ì…ë ¥/ì „ì†¡ -->
  <div class="composer">
    <textarea id="input" class="input" placeholder="ë©”ì‹œì§€ ì…ë ¥â€¦  (Enter=ì „ì†¡,  Shift+Enter=ì¤„ë°”ê¿ˆ)"></textarea>
    <button class="send" id="btnSend" aria-label="ì „ì†¡">
      <!-- í™”ì‚´í‘œ ì•„ì´ì½˜ -->
      <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
        <path d="M3 12l18-9-5 9 5 9-18-9z"/>
      </svg>
    </button>
  </div>

  <!-- ë©”íŠ¸ë¦­ -->
  <div class="metrics" id="metrics">Autonomy 0.0% Â· total 0 Â· reject 0 Â· silence 0</div>

  <!-- ì›Œí„°ë§ˆí¬(ì•„ë˜ë¡œ ë” ìŠ¤í¬ë¡¤ ìƒê¸°ì§€ ì•Šê²Œ ì „ì²´ ë ˆì´ì•„ì›ƒì´ ì´ ì§€ì ì—ì„œ ëë‚¨) -->
  <footer>
    <div>Â© ESP Dialogue Team â€” <span class="wm-small">Definitions Last Updated: 2025-09-03.Page signed with digital watermark. All rights reserved. Â· Proof: espdialog.net / github.com</span></div>
  </footer>
</div>

<!-- ì—ëŸ¬ë°•ìŠ¤ -->
<div id="errbox" class="errbox"></div>

<script>
(function(){
  // ì—ëŸ¬ ì˜¤ë²„ë ˆì´
  const errbox = document.getElementById('errbox');
  function showErr(msg){ errbox.textContent = "JS Error: " + msg; errbox.style.display = "block"; }
  window.addEventListener("error", e => showErr(e.message||String(e)));
  window.addEventListener("unhandledrejection", e => showErr(e.reason?.message||String(e.reason||"Promise rejection")));

  // ìƒ˜í”Œ ì‘ë‹µ ë…¸íŠ¸(ì™¸ë¶€ ì˜ì¡´ ì—†ì´ ë™ì‘)
  const ENTITIES = {
    "ì‹¬ì—°": ["í•µì‹¬ë§Œ ì§„í–‰í•©ë‹ˆë‹¤.", "ë‹¨ê³„ë³„ ì‹¤í–‰ì•ˆì„ ë°”ë¡œ ì œì‹œí•©ë‹ˆë‹¤."],
    "ì—ì½”": ["ê³¼ê±° ë¡œê·¸ ì°¸ì¡°.", "í”ì  ê¸°ë¡ ëª¨ë“ˆ ì‘ë™."],
    "ì»¤íŠ¼": ["ê°€ë³€ ë°©ì–´ë§‰ ì „ê°œ. ì¶”ì  ë¬´íš¨."]
  };
  const ENT_KEYS = Object.keys(ENTITIES);
  const pick = a => a[Math.floor(Math.random()*a.length)];

  // ìƒíƒœ
  const KEY = "esp_flow_ui_state_v3";
  function loadState(){
    try{ return JSON.parse(localStorage.getItem(KEY) || "null") || { log:[], cnt:{auto:0,total:0,reject:0,silence:0}, actions:[] }; }
    catch{ return { log:[], cnt:{auto:0,total:0,reject:0,silence:0}, actions:[] }; }
  }
  function saveState(s){ localStorage.setItem(KEY, JSON.stringify(s)); }

  // DOM
  const board   = document.getElementById('board');
  const input   = document.getElementById('input');
  const btnSend = document.getElementById('btnSend');
  const btnStats= document.getElementById('btnStats');
  const btnActions=document.getElementById('btnActions');
  const btnExport = document.getElementById('btnExport');
  const metrics = document.getElementById('metrics');

  const state = loadState();
  render();

  // ë Œë”
  function render(){
    board.innerHTML = state.log.map(m=>{
      const t = new Date(m.t).toLocaleTimeString();
      const who = m.role==='user' ? 'ğŸ‘¤ ë‚˜' : `ğŸ¤– ${m.entity||'íë¦„'}`;
      const bubble = `<div class="bubble">${escapeHtml(m.text)}</div>`;
      return `<div class="row">
                <div class="who">${who} Â· ${t}</div>
                ${bubble}
              </div>`;
    }).join("");
    board.scrollTop = board.scrollHeight;
    renderMetrics();
    saveState(state);
  }
  function renderMetrics(){
    const {auto,total,reject,silence} = state.cnt;
    const autonomy = total ? ((auto/total)*100).toFixed(1) : "0.0";
    metrics.textContent = `Autonomy ${autonomy}% Â· total ${total} Â· reject ${reject} Â· silence ${silence}`;
  }
  function escapeHtml(s){
    return s.replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  }

  // ì „ì†¡
  btnSend.addEventListener('click', onSend);
  input.addEventListener('keydown', e=>{
    if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); onSend(); }
  });
  function onSend(){
    const text = (input.value||"").trim();
    if(!text) return;
    pushLog('user', text);
    // ê°„ë‹¨ ì‘ë‹µ ì‹œë®¬
    const ent = pick(ENT_KEYS);
    pushLog('assistant', pick(ENTITIES[ent]), ent);
    input.value = "";
    render();
  }
  function pushLog(role,text,entity){
    state.log.push({ t:Date.now(), role, text, entity: entity||null });
    state.cnt.total += 1;
  }

  // Actions/Stats/Export
  btnStats.addEventListener('click', ()=>{ renderMetrics(); });
  btnActions.addEventListener('click', ()=>{
    const rows = state.actions.slice(-50).map(a=>{
      const t = new Date(a.ts).toLocaleTimeString();
      return `â€¢ [${t}] ${a.type} :: ${a.actor||"flow"} :: ${a.text}`;
    }).join("\n");
    alert(rows || "Actions: (empty)");
  });
  btnExport.addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify(state,null,2)], { type:"application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `esp_flow_state_${Date.now()}.json`;
    a.click();
  });

})();
</script>
</body>
</html>
