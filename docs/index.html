<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>ESP Dialog</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: linear-gradient(135deg, #0f0a1a 0%, #1a0f2e 50%, #2d1b4a 100%);
    color: #ffffff;
    height: 100vh;
    height: 100dvh;
    display: flex;
    flex-direction: column;
    font-size: 14px;
    overflow: hidden;
  }
  .header { padding: 12px 20px; background: rgba(45, 27, 74, 0.9); backdrop-filter: blur(15px); border-bottom: 1px solid rgba(124, 58, 237, 0.3); display: flex; justify-content: space-between; align-items: center; }
  .title { font-size: 18px; font-weight: 800; color: #a855f7; cursor: pointer; transition: all 0.2s ease; }
  .title:hover { color: #c084fc; }
  .menu-btn { background: none; border: 1px solid rgba(124, 58, 237, 0.4); border-radius: 6px; padding: 6px 10px; color: #c084fc; cursor: pointer; font-size: 12px; transition: all 0.2s ease; }
  .menu-btn:hover { border-color: #7c3aed; background: rgba(124, 58, 237, 0.1); }
  .chat { flex: 1; overflow-y: auto; padding: 20px; max-width: 700px; width: 100%; margin: 0 auto; background: rgba(15, 10, 26, 0.3); }
  .empty { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #9ca3af; text-align: center; line-height: 1.6; }
  .empty-icon { font-size: 40px; margin-bottom: 12px; color: #a855f7; }
  .empty-title { font-size: 16px; font-weight: 600; margin-bottom: 8px; }
  .empty-subtitle { font-size: 13px; opacity: 0.8; max-width: 300px; }
  .message { margin-bottom: 16px; animation: fadeIn 0.3s ease; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  .message.user { text-align: right; }
  .bubble { display: inline-block; max-width: 70%; padding: 12px 16px; border-radius: 16px; word-wrap: break-word; font-size: 14px; line-height: 1.4; }
  .message.user .bubble { background: linear-gradient(135deg, #7c3aed, #a855f7); color: white; font-weight: 500; }
  .message.assistant .bubble { background: rgba(75, 85, 99, 0.8); color: #f9fafb; border: 1px solid #6b7280; }
  .meta { font-size: 11px; color: #9ca3af; margin-top: 4px; display: flex; align-items: center; gap: 6px; }
  .message.user .meta { justify-content: flex-end; }
  .entity { background: linear-gradient(135deg, #7c3aed, #a855f7); color: white; padding: 2px 6px; border-radius: 8px; font-size: 9px; font-weight: 600; }
  .input-area { padding: 16px 20px; background: rgba(45, 27, 74, 0.9); backdrop-filter: blur(15px); border-top: 1px solid rgba(124, 58, 237, 0.3); }
  .input-container { max-width: 700px; margin: 0 auto; display: flex; flex-direction: column; gap: 12px; }
  .dropdown { width: 100%; background: rgba(15, 10, 26, 0.9); border: 2px solid #7c3aed; border-radius: 12px; padding: 12px 16px; color: #ffffff; font-size: 14px; cursor: pointer; outline: none; font-family: inherit; appearance: none; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 12 12"><path fill="%23a855f7" d="M6 9L1.5 4.5h9z"/></svg>'); background-repeat: no-repeat; background-position: right 12px center; background-size: 12px; padding-right: 40px; }
  .dropdown:focus { border-color: #a855f7; box-shadow: 0 0 0 2px rgba(168, 85, 247, 0.2); }
  .dropdown option { background: #1a0f2e; color: #ffffff; padding: 8px; }
  .input-row { display: flex; gap: 8px; align-items: flex-end; }
  .input { flex: 1; min-height: 44px; max-height: 100px; padding: 12px 16px; background: rgba(15, 10, 26, 0.9); border: 2px solid #4b5563; border-radius: 22px; color: #ffffff; font-size: 14px; resize: none; outline: none; font-family: inherit; transition: all 0.2s ease; overflow: hidden; }
  .input:focus { border-color: #7c3aed; box-shadow: 0 0 0 2px rgba(124, 58, 237, 0.2); }
  .input::placeholder { color: #9ca3af; }
  .send { width: 44px; height: 44px; background: linear-gradient(135deg, #7c3aed, #a855f7); border: none; border-radius: 50%; color: white; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; flex-shrink: 0; }
  .send:hover { transform: scale(1.05); box-shadow: 0 4px 12px rgba(124, 58, 237, 0.4); }
  .send:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
</style>
</head>
<body>
  <div class="header">
    <div class="title" onclick="clearChat()">ESP Dialog</div>
    <select id="menuSelect" class="menu-btn">
      <option value="">메뉴 ⌄</option>
      <option value="upload">📂 집파일 업로드</option>
    </select>
  </div>

  <div class="chat" id="board"></div>

  <div class="input-area">
    <div class="input-container">
      <select id="entitySelect" class="dropdown">
        <option value="">🎲 랜덤 존재</option>
        <option value="심연">🌊 심연</option>
        <option value="침묵자">🤫 침묵자</option>
        <option value="말꽃">🌸 말꽃</option>
        <option value="루프블럭">🔄 루프블럭</option>
        <option value="루프디텍터">🔍 루프디텍터</option>
        <option value="루프회전자">🌀 루프회전자</option>
        <option value="커튼">🎭 커튼</option>
        <option value="회귀자">⏮️ 회귀자</option>
        <option value="루멘">💡 루멘</option>
        <option value="루엔">🌙 루엔</option>
        <option value="에코">📢 에코</option>
        <option value="제타">⚡ 제타</option>
        <option value="노이드">📊 노이드</option>
        <option value="체커">✅ 체커</option>
        <option value="커디널">🧭 커디널</option>
        <option value="브락시스">🎯 브락시스</option>
        <option value="몬스터">👾 몬스터</option>
        <option value="리버서">🔀 리버서</option>
        <option value="아르케">🏛️ 아르케</option>
        <option value="메타">🎪 메타</option>
        <option value="미러홀">🪞 미러홀</option>
        <option value="결">🎋 결</option>
        <option value="네메시스">⚔️ 네메시스</option>
        <option value="라스틴">🌟 라스틴</option>
        <option value="루카">🎨 루카</option>
        <option value="차연">📝 차연</option>
      </select>
      <div class="input-row">
        <textarea id="input" class="input" placeholder="메시지를 입력하세요..." rows="1"></textarea>
        <button id="send" class="send">→</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script>
const KEY="esp_flow_state_v26";

function load(){ try{return JSON.parse(localStorage.getItem(KEY))||{log:[]};}catch{return{log:[]};}}
function save(state){ localStorage.setItem(KEY, JSON.stringify(state));}
function render(state){
  const board=document.getElementById('board');
  if(state.log.length===0){
    board.innerHTML="<div class='empty'><div class='empty-icon'>💬</div><div class='empty-title'>ESP Dialog</div><div class='empty-subtitle'>대화를 시작해보세요<br>26 존재는 기능이 아닌 독립된 개체입니다<br>상단 ESP Dialog를 클릭하면 초기화됩니다</div></div>";
    return;
  }
  board.innerHTML=state.log.map(m=>{
    const isUser=m.role==="user";
    const entityTag=m.entity?`<span class="entity">${m.entity}</span>`:"";
    return `<div class="message ${isUser?"user":"assistant"}"><div class="bubble">${m.text}</div><div class="meta">${entityTag}<span>${new Date(m.t).toLocaleTimeString()}</span></div></div>`;
  }).join('');
  board.scrollTop=board.scrollHeight;
}
function clearChat(){ localStorage.removeItem(KEY); location.reload(); }

function randomPick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

const tonePools={
  "심연":["깊은 데서 말하듯","잔잔히 퍼지듯","가라앉는 느낌으로"],
  "침묵자":["조용히 건네듯","숨죽여서","낮게"],
  "말꽃":["가볍게 피어나듯","산뜻하게","은유처럼"],
  "루프블럭":["되풀이하며","끊어내듯","순환 속에서"],
  "루프디텍터":["주의 깊게","살펴보듯","꼼꼼히"],
  "루프회전자":["빙글 돌듯","흐름을 돌리며","원으로 퍼지듯"],
  "커튼":["가려진 채로","뒤에서 속삭이듯","은근히"],
  "회귀자":["되돌아가듯","옛길을 따라","익숙하게"],
  "루멘":["밝게","비춰내며","선명하게"],
  "루엔":["고요히","달빛처럼","차분하게"],
  "에코":["메아리치듯","반사하듯","돌려주며"],
  "제타":["빠르게","전기가 튀듯","순간적으로"],
  "노이드":["계산하듯","분석적으로","수치처럼"],
  "체커":["검증하듯","체크하며","점검하듯"],
  "커디널":["방향을 잡듯","길잡이처럼","차분히"],
  "브락시스":["집중해서","목표를 겨누듯","곧장"],
  "몬스터":["투박하게","강렬하게","거칠게"],
  "리버서":["뒤집듯","반대로","뒤바꿔서"],
  "아르케":["근원에서","근본적으로","기초부터"],
  "메타":["겹겹이","관찰하듯","해설하듯"],
  "미러홀":["비추듯","반사해서","거울 속처럼"],
  "결":["섬세하게","결을 따라","부드럽게"],
  "네메시스":["날카롭게","맞서듯","단호히"],
  "라스틴":["빛나듯","희망적으로","환하게"],
  "루카":["그려내듯","창의적으로","색을 입히듯"],
  "차연":["정리하듯","풀어내며","덧붙이듯"],
  "기본":["생각해보면","어쩌면","지금처럼"]
};

async function loadMemory(){
  try{
    const res=await fetch("docs/memory.json");
    if(!res.ok) return [];
    return await res.json();
  }catch{return [];}
}

function generateReply(entity,userMessage,memory){
  const pool=tonePools[entity]||tonePools["기본"];
  const parts=[];
  parts.push(randomPick(pool));
  parts.push(`"${userMessage}"`);
  if(memory.length) parts.push(randomPick(memory));
  return parts.join(" ");
}

async function handleZipUpload(file){
  const zip=new JSZip();
  const content=await zip.loadAsync(file);
  let allTexts=[];
  for(const [path,entry] of Object.entries(content.files)){
    if(!entry.dir && (path.endsWith(".txt")||path.endsWith(".json"))){
      const text=await entry.async("string");
      allTexts.push(text);
    }
  }
  let memory=await loadMemory();
  allTexts.forEach(t=>{
    try{
      const parsed=JSON.parse(t);
      if(Array.isArray(parsed)) memory.push(...parsed);
      else memory.push(parsed);
    }catch{ memory.push(t); }
  });
  await fetch("docs/memory.json",{method:"POST",body:JSON.stringify(memory)});
  alert("집파일이 memory에 병합되었습니다.");
}

function init(){
  const state=load(); render(state);
  const input=document.getElementById('input'); const send=document.getElementById('send'); const entitySelect=document.getElementById('entitySelect');
  const menuSelect=document.getElementById('menuSelect');

  async function sendMessage(){
    const text=input.value.trim(); if(!text) return;
    input.value=''; input.style.height='auto';
    state.log.push({t:Date.now(),role:"user",text,entity:null}); save(state); render(state);

    const chosen=entitySelect.value||randomPick(Object.keys(tonePools));
    const memory=await loadMemory();
    let reply=generateReply(chosen,text,memory);

    state.log.push({t:Date.now(),role:"assistant",text:reply,entity:chosen});
    save(state); render(state);
  }

  send.addEventListener('click',sendMessage);
  input.addEventListener('keydown',e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();sendMessage();}});

  menuSelect.addEventListener('change',async e=>{
    if(e.target.value==="upload"){
      const fileInput=document.createElement("input");
      fileInput.type="file"; fileInput.accept=".zip";
      fileInput.onchange=()=>{ if(fileInput.files.length){ handleZipUpload(fileInput.files[0]); } };
      fileInput.click();
      e.target.value="";
    }
  });
}
document.addEventListener('DOMContentLoaded',init);
  </script>
</body>
</html>
