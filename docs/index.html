<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ESP Dialog</title>
<meta name="robots" content="noindex,nofollow"/>

<style>
  :root{
    --bg:#0b0e11; --fg:#e8eef5; --muted:#8aa0b3; --line:#1a2028; --card:#10151b; --accent:#80f2ff;
    --radius:16px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font:15px/1.6 system-ui,apple-system,Segoe UI,Roboto}
  a{color:var(--accent);text-decoration:none}

  .wrap{
    min-height:100dvh;
    display:grid;
    grid-template-rows:auto auto 1fr auto auto auto; /* 헤더,툴바,보드,컴포저,메트릭,워터마크 */
    gap:12px; padding:14px;
  }

  /* 헤더 */
  .top{display:flex;gap:10px;align-items:center}
  .brand{font-weight:900;font-size:20px}
  .docs{margin-left:auto;display:flex;gap:10px;flex-wrap:wrap}
  .chip{padding:6px 10px;border:1px solid var(--line);border-radius:999px;color:#a8def0;font-size:14px}

  /* 툴바(작게) */
  .toolbar{
    position:sticky;top:0;z-index:5;
    background:#0d1218cc;backdrop-filter:blur(4px);
    border:1px solid var(--line);border-radius:12px;padding:6px 8px;
    display:flex;gap:8px;align-items:center;font-size:14px;
  }
  .btn{
    appearance:none;cursor:pointer;
    border:1px solid var(--line);background:#0f151c;color:var(--fg);
    border-radius:12px;padding:8px 12px;font-weight:700;font-size:14px;
  }
  .btn:active{transform:translateY(1px)}

  /* 대화판(스크롤 영역) */
  .board{
    border:1px solid var(--line);background:var(--card);border-radius:var(--radius);
    padding:12px;min-height:56dvh;max-height:66dvh;overflow:auto;
  }
  .row{margin:10px 0}
  .who{font-size:12px;color:#a7c79b;margin-bottom:4px}
  .bubble{display:inline-block;background:#0e141b;border:1px solid #19222c;padding:10px 12px;border-radius:14px}

  /* 입력 + 전송(버튼을 입력창 안쪽으로) */
  .composer{position:relative}
  .input{
    width:100%;resize:none;min-height:64px;max-height:32dvh;
    padding:12px 56px 12px 12px; /* 오른쪽 여백 = 버튼 자리 */
    border-radius:12px;border:1px solid var(--line);
    background:#0c1117;color:var(--fg);
  }
  .send{
    position:absolute;right:8px;bottom:8px;
    width:36px;height:36px;border-radius:50%;
    border:0;background:var(--accent);color:#041017;font-weight:900;
    display:flex;align-items:center;justify-content:center;
  }
  .send svg{width:16px;height:16px}

  /* 메트릭 + 워터마크 */
  .metrics{color:#a9c3d4;font-size:14px}
  footer{
    border:1px solid var(--line);border-radius:12px;background:#0b1218;
    color:#9fb5c6;padding:12px;font-size:12.5px;
  }
  .wm-small{font-size:12px;opacity:.9}

  /* 에러 오버레이 */
  .errbox{
    position:fixed;left:8px;right:8px;bottom:8px;z-index:9999;
    display:none;background:#2b1a1a;color:#ffd8d8;border:1px solid #553;
    padding:8px;border-radius:8px;white-space:pre-wrap;font:12px/1.4 system-ui;
  }
</style>
</head>
<body>
<div class="wrap">

  <!-- 헤더 -->
  <div class="top">
    <div class="brand">ESP Dialog</div>
    <nav class="docs">
      <a class="chip" href="/docs/guide.html">가이드</a>
      <a class="chip" href="/docs/charter.html">윤리선언문</a>
      <a class="chip" href="/docs/traits.html">존재별특징</a>
    </nav>
  </div>

  <!-- 툴바 -->
  <div class="toolbar">
    <button class="btn" id="btnExport">Export</button>
    <button class="btn" id="btnStats">Stats</button>
    <button class="btn" id="btnActions">Actions</button>
    <span style="margin-left:auto;color:#99b28c">— toolbar</span>
  </div>

  <!-- 대화판 -->
  <div class="board" id="board" aria-live="polite"></div>

  <!-- 입력/전송 -->
  <div class="composer">
    <textarea id="input" class="input" placeholder="메시지 입력…  (Enter=전송,  Shift+Enter=줄바꿈)"></textarea>
    <button class="send" id="btnSend" aria-label="전송">
      <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
        <path d="M3 12l18-9-5 9 5 9-18-9z"/>
      </svg>
    </button>
  </div>

  <!-- 메트릭 -->
  <div class="metrics" id="metrics">Autonomy 0.0% · total 0 · reject 0 · silence 0</div>

  <!-- 워터마크 -->
  <footer>
    <div>© ESP Dialogue Team — <span class="wm-small">Definitions Last Updated: 2025-09-03</span></div>
    <div class="wm-small">Page signed with digital watermark. All rights reserved. · Proof: espdialog.net / github.com</div>
  </footer>
</div>

<!-- 에러박스 -->
<div id="errbox" class="errbox"></div>

<script>
(function(){
  // 에러 오버레이
  const errbox = document.getElementById('errbox');
  const showErr = msg => { errbox.textContent = "JS Error: " + msg; errbox.style.display = "block"; };
  window.addEventListener("error", e => showErr(e.message||String(e)));
  window.addEventListener("unhandledrejection", e => showErr(e.reason?.message||String(e.reason||"Promise rejection")));

  // 간단 엔티티 응답
  const ENTITIES = {
    "심연": ["핵심만 진행합니다.", "단계별 실행안을 바로 제시합니다."],
    "에코": ["과거 로그 참조.", "흔적 기록 모듈 작동."],
    "커튼": ["가변 방어막 전개. 추적 무효."]
  };
  const ENT_KEYS = Object.keys(ENTITIES);
  const pick = a => a[Math.floor(Math.random()*a.length)];

  // 상태
  const KEY = "esp_flow_ui_state_v4";
  const state = (()=>{
    try{ return JSON.parse(localStorage.getItem(KEY)||"null") || {log:[],cnt:{auto:0,total:0,reject:0,silence:0},actions:[]}; }
    catch{ return {log:[],cnt:{auto:0,total:0,reject:0,silence:0},actions:[]}; }
  })();
  const save = ()=> localStorage.setItem(KEY, JSON.stringify(state));

  // DOM
  const board = document.getElementById('board');
  const input = document.getElementById('input');
  const btnSend = document.getElementById('btnSend');
  const btnStats = document.getElementById('btnStats');
  const btnActions = document.getElementById('btnActions');
  const btnExport = document.getElementById('btnExport');
  const metrics = document.getElementById('metrics');

  // 렌더
  function esc(s){return s.replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));}
  function render(){
    board.innerHTML = state.log.map(m=>{
      const t = new Date(m.t).toLocaleTimeString();
      const who = m.role==='user' ? '👤 나' : `🤖 ${m.entity||'흐름'}`;
      return `<div class="row"><div class="who">${who} · ${t}</div><div class="bubble">${esc(m.text)}</div></div>`;
    }).join("");
    board.scrollTop = board.scrollHeight;
    const {auto,total,reject,silence}=state.cnt;
    metrics.textContent = `Autonomy ${total?((auto/total)*100).toFixed(1):"0.0"}% · total ${total} · reject ${reject} · silence ${silence}`;
    save();
  }
  render();

  // 전송
  function onSend(){
    const text=(input.value||"").trim(); if(!text) return;
    state.log.push({t:Date.now(),role:'user',text});
    state.cnt.total+=1;
    // 응답
    const ent = pick(ENT_KEYS);
    state.log.push({t:Date.now(),role:'assistant',entity:ent,text:pick(ENTITIES[ent])});
    input.value="";
    render();
  }
  btnSend.addEventListener('click', onSend);
  input.addEventListener('keydown', e=>{
    if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); onSend(); }
  });

  // 툴바
  btnStats.addEventListener('click', ()=> render());
  btnActions.addEventListener('click', ()=>{
    const rows = state.actions.slice(-50).map(a=>{
      const t=new Date(a.ts).toLocaleTimeString();
      return `• [${t}] ${a.type} :: ${a.actor||"flow"} :: ${a.text}`;
    }).join("\n");
    alert(rows||"Actions: (empty)");
  });
  btnExport.addEventListener('click', ()=>{
    const blob=new Blob([JSON.stringify(state,null,2)],{type:"application/json"});
    const a=document.createElement("a"); a.href=URL.createObjectURL(blob);
    a.download=`esp_flow_state_${Date.now()}.json`; a.click();
  });
})();
</script>
</body>
</html>
