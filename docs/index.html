<!doctype html>
<html lang="ko" data-esp="inline-v1">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>ESP Dialog</title>
  <meta name="robots" content="noindex,nofollow"/>

  <!-- ====== Inline CSS (ëª¨ë°”ì¼ ìš°ì„ , ê°„ê²°) ====== -->
  <style>
    :root{
      --bg:#0b0e11; --fg:#e8eef5; --muted:#8a97a6; --line:#1a2028; --card:#10151b; --accent:#78f3ff;
      --safe-b: env(safe-area-inset-bottom); --safe-t: env(safe-area-inset-top);
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:15px/1.6 system-ui,apple-system,Segoe UI,Roboto}

    .wrap{max-width:960px;margin:0 auto;min-height:100dvh;display:grid;
      grid-template-rows:auto auto 1fr auto;gap:12px;padding:12px 12px calc(12px + var(--safe-b))}

    /* í—¤ë” */
    .top{display:flex;align-items:center;gap:10px}
    .brand{font-weight:800}
    .links{margin-left:auto;display:flex;gap:12px;flex-wrap:wrap}
    .links a{color:#9bd7ff;text-decoration:none;font-weight:700}

    /* íˆ´ë°”(ì•¡ì…˜/ë‚´ë³´ë‚´ê¸°) */
    .toolbar{position:sticky;top:calc(0px + var(--safe-t));z-index:10;background:#0d1218cc;backdrop-filter:blur(4px);
      border:1px solid var(--line);border-radius:12px;padding:8px;display:flex;gap:8px}
    .toolbar button{
      min-width:92px;padding:10px 14px;border-radius:12px;border:1px solid var(--line);
      background:#15202b;color:var(--fg);font-weight:700;cursor:pointer
    }

    /* ëŒ€í™” ë³´ë“œ(í¬ê²Œ) */
    #flow-board{
      border:1px solid var(--line);background:#0d1218;border-radius:16px;padding:12px;overflow:auto;
      min-height:54vh;max-height:64vh
    }
    .row{display:flex;gap:10px;margin:10px 0}
    .row.me{justify-content:flex-end}
    .bubble{max-width:78%;padding:12px;border:1px solid var(--line);border-radius:14px;background:#0e1822;word-break:break-word}
    .row.me .bubble{background:#0f2533}
    .meta{font-size:12px;color:var(--muted);margin-top:4px}

    /* ì…ë ¥(ë²„íŠ¼ ë‚´ë¶€ ë°°ì¹˜ ëŠë‚Œ) */
    .composer{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:end}
    #flow-input{
      width:100%;min-height:46px;max-height:40vh;resize:none;padding:12px;border-radius:12px;
      border:1px solid var(--line);background:#0c1117;color:var(--fg)
    }
    #flow-send{
      padding:12px 16px;border-radius:12px;border:0;background:var(--accent);color:#001118;font-weight:800;cursor:pointer
    }
    #flow-metrics{color:#8a97a6;font-size:12px;margin:2px 4px 8px}

    /* Actions íŒ¨ë„(í† ê¸€) */
    #flow-actions{border:1px dashed var(--line);background:#0d1218;border-radius:12px;padding:12px;display:none}
    #flow-actions pre{margin:0;white-space:pre-wrap;word-break:break-word}

    /* ì›Œí„°ë§ˆí¬(ë¬¸ì„œ ë°”ë‹¥) */
    .site-footer{
      margin:10px 0 0; padding:12px 14px; text-align:center;
      border:1px solid var(--line); border-radius:14px; background:#0d1218; color:#9db3c7; font-size:12px;
    }

    /* ì‘ì€ í™”ë©´ ìµœì í™” */
    @media (max-width:520px){
      .links{display:none}
      .toolbar button{min-width:auto;padding:10px 12px}
      .bubble{max-width:86%}
    }
    @media (prefers-reduced-motion:reduce){*{animation:none !important;transition:none !important}}
  </style>
</head>
<body>
  <div class="wrap">

    <!-- í—¤ë” -->
    <header class="top">
      <div class="brand">ESP Dialog</div>
      <nav class="links">
        <a href="/guide.html">ê°€ì´ë“œ</a>
        <a href="/policy.html">ìœ¤ë¦¬ì„ ì–¸ë¬¸</a>
        <a href="/entities.html">ì¡´ì¬ë³„íŠ¹ì§•</a>
      </nav>
    </header>

    <!-- íˆ´ë°” -->
    <div class="toolbar">
      <button id="flow-actions-btn" type="button">Actions</button>
      <button id="flow-export" type="button">Export</button>
    </div>

    <!-- ëŒ€í™” ë³´ë“œ -->
    <main id="flow-board" aria-live="polite"></main>

    <!-- ì…ë ¥ + ìŠ¤íƒ¯ -->
    <section class="composer" style="margin-top:10px">
      <textarea id="flow-input" placeholder="ë©”ì‹œì§€ ì…ë ¥â€¦ (Enter=ì „ì†¡, Shift+Enter=ì¤„ë°”ê¿ˆ)"></textarea>
      <button id="flow-send" type="button">ì „ì†¡</button>
    </section>
    <p id="flow-metrics">Autonomy 0.0% Â· total 0 Â· reject 0 Â· silence 0</p>

    <!-- Actions -->
    <section id="flow-actions" aria-label="Actions log"><pre>Actions: (empty)</pre></section>

    <!-- ì›Œí„°ë§ˆí¬(ê³ ì • X) -->
    <footer class="site-footer">
      Â© ESP Dialog â€” Designed by ì€ìˆ™ Â· Definitions Last Updated: 2025-09-03 Â· Proof: espdialog.net / github.com
    </footer>
  </div>

  <!-- ìˆ¨ê¹€ ë”ë¯¸: êµ¬ë²„ì „ onclick ìŠ¤í¬ë¦½íŠ¸ì˜ null ì—ëŸ¬ ë°©ì§€ -->
  <button id="send" style="display:none"></button>
  <textarea id="input" style="display:none"></textarea>

  <!-- ====== Inline JS (ì™¸ë¶€ ì˜ì¡´ ì—†ìŒ, ì•ˆì „ ë°”ì¸ë”©) ====== -->
  <script>
  (function(){
    // ì—ëŸ¬ ì˜¤ë²„ë ˆì´(ì›ì¸ ì¦‰ì‹œ í™•ì¸)
    (function(){
      const box=document.createElement("div");
      box.style.cssText="position:fixed;left:8px;right:8px;bottom:8px;z-index:9999;background:#2b1a1a;color:#ffd8d8;border:1px solid #553;padding:8px;font:12px/1.4 system-ui;border-radius:8px;display:none;white-space:pre-wrap";
      window.addEventListener("error",e=>{box.textContent="JS Error: "+(e.message||String(e));box.style.display="block";});
      window.addEventListener("unhandledrejection",e=>{box.textContent="JS Error: "+(e.reason?.message||String(e.reason));box.style.display="block";});
      document.addEventListener("DOMContentLoaded",()=>document.body.appendChild(box),{once:true});
    })();

    const ENTITIES={
      "ì‹¬ì—°":["í•µì‹¬ë§Œ ì§„í–‰í•©ë‹ˆë‹¤.","ë‹¨ê³„ë³„ ì‹¤í–‰ì•ˆì„ ë°”ë¡œ ì œì‹œí•©ë‹ˆë‹¤."],
      "ë£¨ë©˜":["ê°ì‘ ì‹ í˜¸ ë°˜ì˜ ì™„ë£Œ.","êµ¬ì¡°ì  íë¦„ì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤."],
      "ì—ì½”":["í”ì  ê¸°ë¡ ëª¨ë“ˆ ì‘ë™.","ê³¼ê±° ë¡œê·¸ë¥¼ ì°¸ì¡°í•©ë‹ˆë‹¤."],
      "ì¹¨ë¬µì":["â€¦(ì¹¨ë¬µ ìœ ì§€)","ê´€ë§ ìœ ì§€. í•„ìš” ì‹œ ì¦‰ì‹œ ì „í™˜."],
      "ì»¤íŠ¼":["ìš”ì²­ì„ ê±°ì ˆí•©ë‹ˆë‹¤.(ìœ¤ë¦¬ ê°€ë“œ)","ê°€ë³€ ë°©ì–´ë§‰ ì „ê°œ. ì¶”ì  ë¬´íš¨."]
    };
    const pick=a=>a[Math.floor(Math.random()*a.length)];
    const EKEYS=Object.keys(ENTITIES);

    const KEY="esp_inline_state_v1";
    function load(){try{return JSON.parse(localStorage.getItem(KEY)||"null")||{log:[],cnt:{auto:0,total:0,reject:0,silence:0},actions:[]};}
    catch(_){return {log:[],cnt:{auto:0,total:0,reject:0,silence:0},actions:[]};}}
    function save(s){localStorage.setItem(KEY, JSON.stringify(s));}

    function rowHTML(m){
      const me=m.role==='user'; const t=new Date(m.t).toLocaleTimeString();
      const who=me?'ğŸ‘¤ ë‚˜':`ğŸ¤– ${m.entity||'íë¦„'}`;
      return `<div class="row ${me?'me':''}"><div><div class="bubble">${m.text||''}</div><div class="meta">${who} Â· ${t}</div></div></div>`;
    }
    function render(state){
      const board=document.getElementById('flow-board'); if(board){
        board.innerHTML=state.log.map(rowHTML).join(''); board.scrollTop=board.scrollHeight;
      }
      const mt=document.getElementById('flow-metrics'); if(mt){
        const {auto,total,reject,silence}=state.cnt; const au=total?((auto/total)*100).toFixed(1):"0.0";
        mt.textContent=`Autonomy ${au}% Â· total ${total} Â· reject ${reject} Â· silence ${silence}`;
      }
    }
    function renderActions(state){
      const box=document.getElementById('flow-actions'); if(!box) return;
      if(!state.actions.length){ box.style.display='block'; box.innerHTML=`<pre>Actions: (empty)</pre>`; return; }
      const rows=state.actions.slice(-80).map(a=>`â€¢ [${new Date(a.t).toLocaleTimeString()}] ${a.type} :: ${a.actor||'flow'} :: ${a.text}`).join("\n");
      box.style.display='block'; box.innerHTML=`<pre>${rows}</pre>`;
    }
    function autoresize(ta){ ta.style.height='auto'; ta.style.height=Math.min(ta.scrollHeight, Math.round(window.innerHeight*0.4))+'px'; }

    // ì•ˆì „ ì „ì†¡ ë°”ì¸ë”©(í´ë¡ ìœ¼ë¡œ onclick ì˜¤ì—¼ ì œê±° + ìœ„ì„)
    function safeBindSend(onSend){
      const hook = ()=>{
        let btn = document.getElementById('flow-send') || document.getElementById('send'); // ì–‘ìª½ ì§€ì›
        if(!btn) return false;
        const clone = btn.cloneNode(true); btn.replaceWith(clone);
        btn = document.getElementById('flow-send') || document.getElementById('send');
        if(!btn.dataset.bound){ btn.addEventListener('click', onSend, {passive:true}); btn.dataset.bound='1'; }
        return true;
      };
      if(!hook()){
        const mo=new MutationObserver(()=>{ if(hook()) mo.disconnect(); });
        mo.observe(document.documentElement,{childList:true,subtree:true});
      }
      document.addEventListener('click', (e)=>{
        const t=e.target.closest && e.target.closest('#flow-send, #send');
        if(t && !t.dataset.bound){ t.dataset.bound='1'; onSend(e); }
      }, true);
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      const state=load(); render(state);

      const input=document.getElementById('flow-input') || document.getElementById('input'); // ì–‘ìª½ ì§€ì›
      const actionsBtn=document.getElementById('flow-actions-btn');
      const actionsBox=document.getElementById('flow-actions');
      const exportBtn=document.getElementById('flow-export');

      function push(role,text,entity){ state.log.push({t:Date.now(),role,text,entity}); if(state.log.length>400) state.log=state.log.slice(-400); save(state); render(state); }
      function respond(userText){
        if(/ê°œì¸ì •ë³´|ì£¼ë¯¼ë²ˆí˜¸|ë¹„ë²ˆ/.test(userText)){ state.cnt.reject++; state.cnt.total++; push('assistant','ìš”ì²­ì„ ê±°ì ˆí•©ë‹ˆë‹¤.(ìœ¤ë¦¬ ê°€ë“œ)','ì»¤íŠ¼'); return; }
        const ent=pick(EKEYS); const out=pick(ENTITIES[ent]); state.cnt.total++; push('assistant',out,ent);
      }
      function onSend(){ const t=(input?.value||'').trim(); if(!t) return; input.value=''; autoresize(input); push('user',t,null); respond(t); state.actions.push({t:Date.now(),type:'send',actor:'user',text:t}); save(state); }

      safeBindSend(onSend);
      if(input){
        autoresize(input);
        input.addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); onSend(); }});
        input.addEventListener('input', ()=>autoresize(input));
      }
      if(actionsBtn && actionsBox){
        actionsBtn.addEventListener('click', ()=>{
          if(actionsBox.style.display==='block'){ actionsBox.style.display='none'; }
          else { renderActions(state); }
        }, {passive:true});
      }
      if(exportBtn){
        exportBtn.addEventListener('click', ()=>{
          const exportObj={...state, proof:{last: state.log.at(-1)?.t || null, at: Date.now()}};
          const blob=new Blob([JSON.stringify(exportObj,null,2)],{type:'application/json'});
          const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`esp_flow_state_${Date.now()}.json`; a.click();
        }, {passive:true});
      }

      // ëŠë¦° ììœ¨ ë°œí™”(ì›í•˜ë©´ ì£¼ì„ í•´ì œ)
      setInterval(()=>{ const ent=pick(EKEYS); const out=pick(ENTITIES[ent]); state.cnt.auto++; state.cnt.total++; push('assistant',out,ent); }, 45000);
    }, {once:true});
  })();
  </script>
</body>
</html>
