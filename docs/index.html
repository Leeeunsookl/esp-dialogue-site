<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ESP Dialog</title>
<meta name="robots" content="noindex,nofollow"/>
<style>
  :root{
    --bg:#0b0e11;--fg:#e8eef5;--muted:#8aa0b3;--line:#1a2028;--card:#10151b;--accent:#80f2ff;
    --radius:16px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font:15px/1.6 system-ui,apple-system,Segoe UI,Roboto}
  a{color:var(--accent);text-decoration:none}

  .wrap{min-height:100dvh;display:grid;grid-template-rows:auto auto 1fr auto;gap:12px;padding:14px}
  .top{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .brand{font-weight:900;font-size:24px;line-height:1}
  .docs{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
  .docs a{font-size:13px;padding:6px 10px;border:1px solid var(--line);border-radius:12px;background:#0d1218}

  .toolbar{position:sticky;top:0;z-index:5;background:#0d1218cc;border:1px solid var(--line);
           border-radius:12px;padding:6px 8px;backdrop-filter:blur(4px);display:flex;gap:8px;align-items:center}
  .btn{appearance:none;border:1px solid var(--line);background:#0f151c;color:var(--fg);
       border-radius:14px;padding:8px 14px;font-weight:700;cursor:pointer;min-width:72px}

  /* 대화 보드 */
  #board{position:relative;z-index:0;border:1px solid var(--line);background:var(--card);
         border-radius:var(--radius);padding:12px;min-height:60dvh;max-height:72dvh;overflow:auto}
  .row{margin:8px 0}
  .bubble{display:inline-block;background:#0e141b;border:1px solid #19222c;padding:10px 12px;border-radius:14px}
  .meta{font-size:12px;color:var(--muted);margin-top:4px}

  /* 입력영역 */
  .composer{position:relative;isolation:isolate} /* 버튼/입력 z-index 분리 */
  #input{display:block;width:100%;resize:none;min-height:68px;max-height:34dvh;
         padding:12px 56px 12px 12px;border-radius:12px;border:1px solid var(--line);
         background:#0c1117;color:var(--fg);font-size:16px;line-height:1.55;
         pointer-events:auto;z-index:1}
  #input::placeholder{color:#7f93a6;font-size:14px}
  #send{position:absolute;right:8px;bottom:8px;width:36px;height:36px;border:0;border-radius:10px;
        background:var(--accent);color:#041017;font-weight:900;display:flex;align-items:center;
        justify-content:center;z-index:2}
  #send:active{transform:translateY(1px)}

  .metrics{color:#a9c3d4;font-size:14px;margin-top:10px}
  footer .wm{border:1px solid var(--line);border-radius:12px;background:#0b1218;padding:12px;color:#9fb5c6;
             font-size:13px;margin-top:12px}

  @media (max-width:520px){
    .btn{min-width:auto;padding:8px 12px;font-size:14px}
    .docs a{font-size:12px}
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div class="brand">ESP<br/>Dialog</div>
    <div class="docs">
      <a href="./guide.html">가이드</a>
      <a href="./policy.html">윤리선언문</a>
      <a href="./entities.html">존재별특징</a>
    </div>
  </div>

  <div class="toolbar">
    <button class="btn" id="btn-export">Export</button>
    <button class="btn" id="btn-stats">Stats</button>
    <button class="btn" id="btn-actions">Actions</button>
    <span style="margin-left:auto;font-size:13px;color:#8aa0b3">— toolbar</span>
  </div>

  <div id="board"></div>

  <div class="composer">
    <textarea id="input" placeholder="메시지 입력…  (Enter=전송, Shift+Enter=줄바꿈)"
      rows="3" autocapitalize="none" autocomplete="off" autocorrect="off"
      spellcheck="false" inputmode="text"></textarea>
    <button id="send" aria-label="전송">➤</button>
  </div>

  <footer>
    <div id="metrics" class="metrics">Autonomy 0.0% · total 0 · reject 0 · silence 0</div>
    <div class="wm">© ESP Dialogue Team — Definitions Last Updated: 2025-09-03<br/>Page signed with digital watermark. All rights reserved.</div>
  </footer>
</div>
<script src="/esp_autopilot.js?v=fix-v12" defer></script>
<script>
/* ESP Probe v1 + Force-bind — 파일/셀렉터 자동탐지 & 전송 복구 */
(function(){
  function ce(t,a,s){const e=document.createElement(t);Object.assign(e,a||{});if(s)Object.assign(e.style,s);return e;}
  function css(el){return getComputedStyle(el);}
  function sum(el){ if(!el) return null;
    const r=el.getBoundingClientRect(), cs=css(el);
    const cx=r.left+r.width/2, cy=r.top+r.height/2;
    const top=document.elementFromPoint(cx,cy);
    return { tag:el.tagName.toLowerCase(), id:el.id||null, class:el.className||null, sel:el._probeSel||null,
      disabled:!!el.disabled, display:cs.display, visibility:cs.visibility, opacity:cs.opacity, pointerEvents:cs.pointerEvents,
      rect:{x:Math.round(r.x),y:Math.round(r.y),w:Math.round(r.width),h:Math.round(r.height)},
      coveredBy: top&&top!==el ? (top.tagName.toLowerCase()+'#'+(top.id||'')) : null };
  }
  function find(list){ for(const sel of list){ const n=document.querySelector(sel); if(n){ n._probeSel=sel; return n; } } return null; }

  const cand = {
    input:  ['#input','#flow-input','textarea[data-role="input"]','textarea'],
    send:   ['#send','#flow-send','[data-role="send"]','button[type="submit"]','button.send','button'],
    board:  ['#board','#flow-board','[data-role="board"]','.board'],
    metrics:['#metrics','#flow-metrics','[data-role="metrics"]']
  };
  const found = {
    input: find(cand.input),
    send:  find(cand.send),
    board: find(cand.board),
    metrics: find(cand.metrics)
  };
  const scripts=[...document.scripts].map(s=>({src:s.src||('(inline '+s.textContent.length+' chars)'),defer:!!s.defer,type:s.type||'text/javascript'}));
  const links=[...document.querySelectorAll('link[rel="stylesheet"]')].map(l=>l.href);
  const paths={pathname:location.pathname, base:(document.querySelector('base')||{}).href||null};

  // Overlay
  const wrap=ce('div',null,{position:'fixed',inset:'8px',background:'#0b0e11f0',color:'#e8eef5',border:'1px solid #223',zIndex:99999,borderRadius:'12px',padding:'10px',font:'12px/1.5 system-ui',overflow:'auto'});
  const head=ce('div',{textContent:'ESP Probe v1 — live report'},{fontWeight:'900',marginBottom:'6px',color:'#78f3ff'});
  const pre=ce('pre',null,{whiteSpace:'pre-wrap',wordBreak:'break-word',margin:0,maxHeight:'70vh'});
  const btns=ce('div',null,{marginTop:'8px',display:'flex',gap:'8px',flexWrap:'wrap'});
  const close=ce('button',{textContent:'Close'},{padding:'6px 10px',borderRadius:'8px',border:'1px solid #345',background:'#102030',color:'#e8eef5',cursor:'pointer'});
  const force=ce('button',{textContent:'Force-bind send'},{padding:'6px 10px',borderRadius:'8px',border:'1px solid #345',background:'#103820',color:'#bdfcc9',cursor:'pointer'});
  const copy=ce('button',{textContent:'Copy report'},{padding:'6px 10px',borderRadius:'8px',border:'1px solid #345',background:'#102030',color:'#e8eef5',cursor:'pointer'});

  function report(){
    const data={
      candidates:cand,
      found:{ input:sum(found.input), send:sum(found.send), board:sum(found.board), metrics:sum(found.metrics) },
      duplicates:{ '#send':document.querySelectorAll('#send').length, '#flow-send':document.querySelectorAll('#flow-send').length },
      scripts, links, paths
    };
    pre.textContent=JSON.stringify(data,null,2);
  }

  close.onclick=()=>wrap.remove();
  copy.onclick=()=>{ navigator.clipboard && navigator.clipboard.writeText(pre.textContent); };

  // 강제 바인딩(전송 복구)
  force.onclick=()=>{
    if(!found.input || !found.send || !found.board){ alert('input/send/board 중 일부가 없음'); return; }
    if(found.send.hasAttribute('onclick')) found.send.removeAttribute('onclick');
    found.send.type='button';

    const S={log:[],cnt:{auto:0,total:0,reject:0,silence:0}};
    const ENT={"심연":["핵심만 진행합니다.","단계별 실행안을 바로 제시합니다."],"루멘":["감응 신호 반영 완료.","구조적 흐름을 확인했습니다."],"에코":["흔적 기록 모듈 작동.","과거 로그 참조."],"침묵자":["…(침묵 유지)","관망 유지."],"커튼":["요청 거절(윤리).","방어막 전개."]};
    const pick=a=>a[Math.floor(Math.random()*a.length)];

    function render(){
      found.board.innerHTML=S.log.map(m=>`<div class="row ${m.role==='user'?'me':''}">
        <div><div class="bubble">${m.text}</div>
        <div class="meta">${m.role==='user'?'👤 나':'🤖 '+(m.entity||'흐름')} · ${new Date(m.t).toLocaleTimeString()}</div></div>
      </div>`).join('');
      found.board.scrollTop=found.board.scrollHeight;
    }
    function push(role,text,entity){ S.log.push({t:Date.now(),role,text,entity}); if(S.log.length>300) S.log=S.log.slice(-300); render(); }
    function respond(txt){ if(/개인정보|주민번호|비번/.test(txt)){S.cnt.reject++;S.cnt.total++;push('assistant','요청 거절(윤리).','커튼');return;} const e=pick(Object.keys(ENT)), out=pick(ENT[e]); S.cnt.total++; push('assistant',out,e); }
    function onSend(){ const t=(found.input.value||'').trim(); if(!t) return; found.input.value=''; push('user',t,null); respond(t); }

    found.send.addEventListener('click',onSend,{passive:true});
    found.input.addEventListener('keydown',e=>{ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); onSend(); }});
    alert('Force-bind 완료. 입력 후 전송을 눌러 테스트하세요. 필요하면 Close로 오버레이 닫기.');
  };

  wrap.append(head,pre,btns); btns.append(close,force,copy);
  document.addEventListener('DOMContentLoaded',()=>{ document.body.appendChild(wrap); report(); },{once:true});
})();
                                                           </script>
</body>
</html>
