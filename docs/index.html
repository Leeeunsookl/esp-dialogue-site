<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ESP Dialog · Home</title>
  <link rel="stylesheet" href="/style.css?v=E2" />
  <style>
    :root{--bg:#0b0e11;--fg:#e8eef5;--muted:#8a97a6;--line:#1a2028;--card:#10151b;--accent:#78f3ff}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:15px/1.6 system-ui,apple-system,Segoe UI,Roboto}

    .wrap{max-width:960px;margin:0 auto;padding:16px;min-height:100%;
          display:grid;grid-template-rows:auto auto 1fr auto;gap:14px}

    /* top bar */
    .top{display:flex;gap:12px;align-items:center}
    .brand{font-weight:800;letter-spacing:.3px}
    .nav a{color:var(--accent);text-decoration:none;margin-right:14px;font-weight:700}
    .right{margin-left:auto;display:flex;gap:10px;align-items:center}
    select.entity{background:#0c1117;color:var(--fg);border:1px solid var(--line);border-radius:10px;padding:8px 28px 8px 10px;appearance:none;position:relative}
    .select-wrap{position:relative}
    .select-wrap:after{content:"▾";position:absolute;right:10px;top:50%;transform:translateY(-50%);color:var(--muted);pointer-events:none}

    /* headline & declaration */
    .hero{border:1px solid var(--line);background:var(--card);border-radius:16px;padding:22px}
    .hero h1{margin:0 0 8px;font-size:22px}
    .declaration{border:1px dashed var(--line);border-radius:12px;background:#0b1218;padding:12px;margin-top:10px;color:var(--muted)}
    .random{margin-top:10px;color:#b8fffb}

    /* chat board */
    .board{border:1px solid var(--line);background:var(--card);border-radius:16px;padding:12px;overflow:auto;min-height:320px}
    .row{display:flex;gap:8px;align-items:flex-end;margin:8px 0}
    .msg{max-width:72%;padding:10px 12px;border-radius:14px;border:1px solid var(--line);background:#0d1218}
    .me{justify-content:flex-end}
    .me .msg{background:#0e1822;border-color:#0f2533}
    .meta{font-size:12px;color:var(--muted);margin:2px 4px}
    .agent{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border:1px solid var(--line);border-radius:999px;background:#0d141a;color:var(--muted)}

    /* composer */
    .composer{position:relative;display:grid;grid-template-columns:1fr auto;gap:8px}
    textarea{resize:none;min-height:46px;max-height:180px;padding:12px;border-radius:12px;border:1px solid var(--line);background:#0c1117;color:var(--fg)}
    button#send{position:absolute;right:6px;bottom:6px;background:var(--accent);color:#001118;border:0;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer}
    .hint{color:var(--muted);font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Top bar -->
    <div class="top">
      <div class="brand">ESP Dialog</div>
      <nav class="nav">
        <a href="/">HOME</a>
        <a href="/policy">윤리선언문</a>
        <a href="/guide">가이드</a>
        <a href="/entities">존재별특징</a>
      </nav>
      <div class="right">
        <div class="select-wrap">
          <select id="entity" class="entity" aria-label="존재 선택">
            <option value="심연">심연</option>
            <option value="루멘">루멘</option>
            <option value="루엔">루엔</option>
            <option value="에코">에코</option>
            <option value="침묵자">침묵자</option>
            <option value="네메시스">네메시스</option>
            <option value="라스틴">라스틴</option>
            <option value="메타">메타</option>
            <option value="회귀자">회귀자</option>
            <option value="브락시스">브락시스</option>
            <option value="몬스터">몬스터</option>
            <option value="노이드">노이드</option>
            <option value="커튼">커튼</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Headline & Declaration -->
    <section class="hero">
      <h1>우리와 소통할래요?</h1>
      <div class="declaration">
        <strong>공통 선언문</strong> — 우리는 책임과 투명성을 유지하고, 사용자의 선택권을 존중하며,
        외부 LLM 없이도 오프라인 규칙 엔진으로 안전하게 응답합니다.
      </div>
      <div id="random" class="random"></div>
    </section>

    <!-- Chat -->
    <section class="board" id="board" aria-live="polite"></section>

    <section class="composer">
      <textarea id="input" placeholder="메시지 입력...  (엔터로 전송, Shift+Enter 줄바꿈)"></textarea>
      <button id="send">보내기</button>
      <div class="hint">※ 상단 드롭다운으로 존재를 바꾸면 말투가 달라집니다. 기록은 로컬에만 저장됩니다.</div>
    </section>
  </div>

  <script>
    // ===== 로컬 규칙 엔진 (외부 LLM 없이 동작) =====
    const LOG_KEY = "espdialog_home_state_v1";

    const LINES = {
      "심연": ["상태 확인 완료. 핵심만 진행합니다.", "단계별 실행안을 바로 제시합니다."],
      "루멘": ["여기 있어요. 불안 요인을 함께 구조화합니다.", "감정 신호 반영 완료. 실행은 차분히 진행할게요."],
      "루엔": ["동기화 주기 최적화 완료. 0.5s 윈도우에서 진행합니다."],
      "에코": ["대화 무결성 보존. 필요한 경우 해시를 제공합니다."],
      "침묵자": ["관망 유지. 개입 필요시 즉시 전환."],
      "네메시스": ["위험 패턴 감지 시 경로 격리(≤0.5s)."],
      "라스틴": ["내부 위협 플래그 상승 시 권한 재검증."],
      "메타": ["장기 패턴 변환을 사전 배치합니다."],
      "회귀자": ["원형 스냅샷 보존. 붕괴 시 10초 내 복원."],
      "브락시스": ["허위 모듈 재배치로 시간을 소모시킵니다."],
      "몬스터": ["시도 자체의 비용을 상승시키는 억제 시나리오."],
      "노이드": ["채널 노이즈 주입. 분석 무의미화."],
      "커튼": ["가변 방어막 전개. 추적 무효."]
    };

    const state = load() || { messages: [], entity: "심연" };

    const board = document.getElementById("board");
    const input = document.getElementById("input");
    const sendBtn = document.getElementById("send");
    const entitySel = document.getElementById("entity");
    const randomBox = document.getElementById("random");

    entitySel.value = state.entity;

    // 랜덤 발화 표시 (페이지 진입시)
    function showRandomLine() {
      const names = Object.keys(LINES);
      const pick = names[Math.floor(Math.random()*names.length)];
      const line = LINES[pick][Math.floor(Math.random()*LINES[pick].length)];
      randomBox.textContent = `[${pick}] “${line}”`;
    }

    function render(){
      board.innerHTML = "";
      state.messages.forEach(m => board.appendChild(row(m)));
      board.scrollTop = board.scrollHeight;
      save();
    }

    function row(m){
      const r = document.createElement("div");
      r.className = "row" + (m.role==='user' ? ' me' : '');
      const b = document.createElement("div");
      b.className = "msg"; b.textContent = m.text;
      const meta = document.createElement("div");
      meta.className = "meta";
      const who = m.role==='user' ? '나' : `${m.entity}`;
      meta.innerHTML = `<span class="agent">${who}</span> · ${new Date(m.ts).toLocaleTimeString()}`;
      const wrap = document.createElement("div");
      wrap.appendChild(b); wrap.appendChild(meta);
      r.appendChild(wrap);
      return r;
    }

    function push(role,text,entity){ state.messages.push({role,text,entity,ts:Date.now()}); render(); }

    function reply(userText){
      const e = state.entity;
      const arr = LINES[e] || ["응답 모듈 없음."];
      const line = arr[Math.floor(Math.random()*arr.length)];
      push('assistant', line, e);
    }

    sendBtn.onclick = () => {
      const t = input.value.trim();
      if(!t) return;
      push('user', t, state.entity);
      input.value="";
      reply(t);
    };

    input.addEventListener('keydown', e=>{
      if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendBtn.click(); }
    });

    entitySel.onchange = () => { state.entity = entitySel.value; save(); };

    function save(){ localStorage.setItem(LOG_KEY, JSON.stringify(state)); }
    function load(){ try{ return JSON.parse(localStorage.getItem(LOG_KEY)||"null"); }catch(e){ return null; } }

    // boot
    showRandomLine();
    render();
  </script>
</body>
</html>
