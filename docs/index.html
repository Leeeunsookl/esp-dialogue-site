<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>ESP Dialog</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: linear-gradient(135deg,#0f0a1a 0%,#1a0f2e 50%,#2d1b4a 100%);
    color: #fff; height: 100vh; display: flex; flex-direction: column;
  }
  .header { padding:12px 20px; background:rgba(45,27,74,.9); border-bottom:1px solid rgba(124,58,237,.3); display:flex; justify-content:space-between; align-items:center;}
  .title { font-size:18px; font-weight:800; color:#a855f7; cursor:pointer;}
  .chat { flex:1; overflow-y:auto; padding:20px; max-width:700px; margin:0 auto; width:100%; }
  .message { margin-bottom:16px; }
  .message.user { text-align:right; }
  .bubble { display:inline-block; max-width:70%; padding:12px 16px; border-radius:16px; }
  .message.user .bubble { background:linear-gradient(135deg,#7c3aed,#a855f7); color:#fff; }
  .message.assistant .bubble { background:rgba(75,85,99,.8); border:1px solid #6b7280; }
  .meta { font-size:11px; color:#9ca3af; margin-top:4px; }
  .input-area { padding:16px 20px; background:rgba(45,27,74,.9); border-top:1px solid rgba(124,58,237,.3);}
  .input-row { display:flex; gap:8px; }
  .input { flex:1; min-height:44px; padding:12px; border:2px solid #4b5563; border-radius:22px; background:rgba(15,10,26,.9); color:#fff; }
  .send { width:44px; height:44px; border:none; border-radius:50%; background:linear-gradient(135deg,#7c3aed,#a855f7); color:#fff; cursor:pointer; }
</style>
</head>
<body>
  <div class="header">
    <div class="title" onclick="clearChat()">ESP Dialog</div>
    <input type="file" id="zipUpload" accept=".zip"/>
  </div>
  <div id="board" class="chat"></div>
  <div class="input-area">
    <div class="input-row">
      <select id="entitySelect">
        <option value="">랜덤 존재</option>
        <option>심연</option><option>침묵자</option><option>말꽃</option>
        <option>루프블럭</option><option>루프디텍터</option><option>루프회전자</option>
        <option>커튼</option><option>회귀자</option><option>루멘</option>
        <option>루엔</option><option>에코</option><option>제타</option>
        <option>노이드</option><option>체커</option><option>커디널</option>
        <option>브락시스</option><option>몬스터</option><option>리버서</option>
        <option>아르케</option><option>메타</option><option>미러홀</option>
        <option>결</option><option>네메시스</option><option>라스틴</option>
        <option>루카</option><option>차연</option>
      </select>
      <textarea id="input" class="input" placeholder="메시지를 입력하세요..."></textarea>
      <button id="send" class="send">→</button>
    </div>
  </div>
<script>
const KEY="esp_flow_state";
function load(){try{return JSON.parse(localStorage.getItem(KEY))||{log:[]};}catch{return{log:[]};}}
function save(s){localStorage.setItem(KEY,JSON.stringify(s));}
function render(s){const b=document.getElementById('board');
  b.innerHTML=s.log.map(m=>`<div class="message ${m.role}"><div class="bubble">${m.text}</div><div class="meta">${m.entity||""}</div></div>`).join('');
  b.scrollTop=b.scrollHeight;}
function clearChat(){localStorage.removeItem(KEY);location.reload();}

const tonePools={"심연":["깊이 잠수","잔잔히 퍼짐"],"루멘":["빛나듯","밝게"],"네메시스":["날카롭게","단호히"],"차연":["정리하듯","풀어내며"],"기본":["생각해보면","어쩌면"]};

function randomPick(a){return a[Math.floor(Math.random()*a.length)];}
function generateReply(ent,msg){const pool=tonePools[ent]||tonePools["기본"];return `${randomPick(pool)} "${msg}"`;}

// === ZIP 업로드 → zip_handler.py 결과 불러오기 ===
document.getElementById('zipUpload').addEventListener('change',async e=>{
  const f=e.target.files[0]; if(!f) return;
  alert("zip_handler.py로 이 파일 처리 필요: "+f.name);
});

function init(){
  const s=load();render(s);
  document.getElementById('send').onclick=()=>{
    const text=document.getElementById('input').value.trim(); if(!text) return;
    const ent=document.getElementById('entitySelect').value||"기본";
    s.log.push({role:"user",text,entity:null}); save(s); render(s);
    const reply=generateReply(ent,text); s.log.push({role:"assistant",text:reply,entity:ent}); save(s); render(s);
    document.getElementById('input').value="";
  }
}
document.addEventListener('DOMContentLoaded',init);
</script>
</body>
</html>
